# EMU3000 維修物料清單匯入說明

## 1. 資料來源
- **路徑**: `Database/data/EMU3000/EMU 3000 維修物料清單`
- **格式**: Excel (.xlsx)

## 2. 檔案結構分析
經過分析，Excel 檔案通常包含多個層級的物料結構。

### 欄位定義
- **Part**: 項次 / 行號 (Line Number)。
    - 若為 **數值** (如 1, 2, 3...)：代表該行是上層總成的 **元件 (Component)**。
    - 若為 **空值 (NaN/Null)**：代表該行是一個 **總成 (Assembly)** 的定義，或者是新的 BOM 表頭。
- **Item number**: 料號。
- **Name**: 品名 (通常包含中文與英文)。
- **Quantity**: 數量。
- **Unit**: 單位。
- **WEC**: WEC 編碼 (部分檔案有)。
- **Notes**: 備註。
- **Kit No**: 套件編號。

### 結構邏輯
一個檔案中可能包含多個 BOM 結構。讀取邏輯如下：

1.  **總成識別 (Assembly)**:
    - 當 `Part` 欄位為 **空值** 且 `Item number` 有值時。
    - 視為一個新的 BOM 開頭。
    - 系統應建立一個 `Item` (Type: FG) 和一個 `BOM` 表頭。
    - 後續的元件將隸屬於此 BOM，直到遇到下一個總成。

2.  **元件識別 (Component)**:
    - 當 `Part` 欄位為 **數值** 時。
    - 視為當前 BOM 的 `BOM_LINE`。
    - `Part` 的值即為 `line_no`。
    - 系統應建立一個 `Item` (Type: SEMI) 並將其加入 `BOM_LINE`。

## 3. 資料清洗規則 (Data Cleaning)
為確保資料庫整潔，必須執行以下清洗：

1.  **空值處理**:
    - Excel 中的 `NaN` 或 `Empty` 必須轉換為資料庫的 `NULL`。
    - **嚴禁** 將 `NaN` 轉換為字串 `"nan"` 或 `"null"`。
    - 涉及欄位：`Part`, `Quantity`, `Unit`, `WEC`, `Notes`, `Kit No`。

2.  **字串處理**:
    - 所有文字欄位必須去除前後空白 (`strip()`)。
    - `Item number` 若為浮點數格式 (如 `123.0`) 需轉為整數或字串。

3.  **重複處理**:
    - 若同一檔案中出現相同的總成，應視為資料重複或更新，避免建立重複的 BOM Header。
    - 若 `Part` (Line No) 重複，需檢查是否為資料錯誤，或自動遞增處理。

## 4. 匯入流程
1.  **清空資料**: 根據需求，匯入前清空相關資料表 (`item_emu3000_maintenance_ext`, `bom_line`, `bom`, `item`)。
2.  **遍歷檔案**: 讀取所有非原始資料的 Excel 檔。
3.  **逐行解析**: 依上述結構邏輯識別 Assembly 與 Component。
4.  **寫入資料庫**: 使用 `INSERT` 寫入，並確保 `NULL` 值正確。
