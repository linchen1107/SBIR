# EMU3000 維修物料清單資料導入操作指南

## 📋 文件資訊

- **專案**: SBIR 通用型裝備資料庫
- **用途**: 將台鐵 EMU3000 維修物料清單導入資料庫
- **建立日期**: 2025-11-24
- **資料庫**: sbir_equipment_db_v2
- **資料量**: 91個Excel檔案，約3,000-5,000個零件

---

## 📂 相關文件

| 文件名稱 | 說明 | 位置 |
|---------|------|------|
| **EMU3000_維修物料清單說明.md** | 資料結構詳細說明 | `Database/docs/` |
| **EMU3000_資料驗證報告.md** | 資料驗證結果 | `Database/docs/` |
| **alter_database_for_emu3000.sql** | 資料庫結構調整腳本 | `Database/scripts/` |
| **import_emu3000_data.py** | 資料導入腳本 | `Database/scripts/` |

---

## 🔍 資料驗證結果摘要

###檔案統計

| 維護週期 | 檔案數 | 狀態 |
|---------|--------|------|
| 5年(60個月) | 1 | ✅ 正常 |
| 6年(72個月) | 7 | ✅ 正常 |
| 8年(96個月) | 50 | ✅ 正常 |
| 16年(192個月) | 33 | ✅ 正常 |
| 20年(240個月) | 0 | ⚠️ 無檔案 |
| **總計** | **91** | **✅ 與文件一致** |

### 資料結構

- **每個檔案包含 2 個工作表**: 定更件、定檢件
- **欄位完整**: Part, Item number, Quantity, Unit, Name, WEC, Notes, Kit No
- **資料層級**: 裝備資訊（Part=NULL） + 零件清單（Part!=NULL）
- **WEC代碼**: A/B/C 三種代碼（D代碼目前未使用）

### 資料品質評估

✅ **優秀**: 文件內容與實際資料 100% 一致
- 檔案數量統計: ✅ 完全正確
- 檔案結構描述: ✅ 完全正確
- 資料範例: ✅ 完全正確

---

## 🚀 導入流程

### 階段一：資料庫結構調整

#### 1.1 執行結構調整腳本

```bash
PGPASSWORD=willlin07 "/c/Program Files/PostgreSQL/16/bin/psql.exe" \
  -U postgres \
  -h localhost \
  -p 5432 \
  -d sbir_equipment_db_v2 \
  -f "c:/github/SBIR/Database/scripts/alter_database_for_emu3000.sql"
```

#### 1.2 新增的欄位

| 表名 | 欄位 | 類型 | 說明 |
|-----|------|------|------|
| Item | project_code | VARCHAR(20) | 專案代碼（EMU3000） |
| BOM | sheet_type | VARCHAR(20) | 工作表類型（定更件/定檢件） |
| BOM | maintenance_period | INT | 維護週期（60/72/96/192/240） |
| BOM_LINE | kit_no | VARCHAR(50) | 套件編號 |
| BOM_LINE | wec_code | VARCHAR(5) | WEC代碼（A/B/C/D） |
| Item_Equipment_Ext | equipment_location | VARCHAR(50) | 裝備位置（A01T0等） |

#### 1.3 新建的表

**WEC_Code 表**: WEC 代碼說明表（含 A/B/C/D 四種代碼定義）

#### 1.4 驗證結構調整

```sql
-- 檢查欄位是否已新增
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'Item' AND column_name = 'project_code';

-- 檢查 WEC_Code 表
SELECT * FROM WEC_Code;
```

---

### 階段二：測試導入（建議先測試）

#### 2.1 測試資料庫連線

```bash
cd c:/github/SBIR
python Database/scripts/import_emu3000_data.py
```

**預期輸出**:
```
INFO - EMU3000 資料導入程式（簡化版）
INFO - 資料庫連線成功！
INFO - ✓ 資料庫結構已更新（project_code 欄位存在）
INFO - 現有 EMU3000 品項數量: 0
```

#### 2.2 測試單一檔案導入（手動測試）

選擇最簡單的檔案進行測試：

**測試檔案**: `清潔塊單元C20、C21大修料件清單--60個月.xlsx`

使用 Python 腳本測試讀取：

```python
import pandas as pd

file_path = r'c:/github/SBIR/Database/data/EMU3000/EMU 3000 維修物料清單/5年維護/01 清潔塊單元--C20、C21--OK/清潔塊單元C20、C21大修料件清單--60個月.xlsx'

xls = pd.ExcelFile(file_path)
print(f'工作表: {xls.sheet_names}')

# 讀取定檢件
df = pd.read_excel(file_path, sheet_name='定檢件')
print(f'總行數: {len(df)}')
print(df.head(10))
```

---

### 階段三：批次導入

#### 3.1 資料導入策略

**建議採用分階段導入**:

1. **第一階段**: 5年維護（1個檔案）- 驗證流程
2. **第二階段**: 6年維護（7個檔案）- 小批次測試
3. **第三階段**: 16年維護（33個檔案）- 中批次測試
4. **第四階段**: 8年維護（50個檔案）- 大批次導入

#### 3.2 資料導入流程（每個檔案）

```
1. 讀取 Excel 檔案
   ↓
2. 解析裝備資訊（Part=NULL）
   → 裝備代碼、名稱、位置
   ↓
3. 建立裝備主檔
   → INSERT INTO Item (item_type='FG', project_code='EMU3000')
   → INSERT INTO Item_Equipment_Ext
   ↓
4. 為每個工作表建立 BOM
   → INSERT INTO BOM (sheet_type, maintenance_period)
   ↓
5. 處理零件清單（Part!=NULL）
   → 檢查料號是否已存在
   → 如果不存在: INSERT INTO Item (item_type='RM')
   → INSERT INTO BOM_LINE
   ↓
6. 提交交易
```

#### 3.3 關鍵處理邏輯

##### 料號唯一性處理

```python
def get_or_create_item(item_number, name, item_type, uom):
    """取得或建立品項"""

    # 檢查料號是否已存在
    existing_item = db.query("SELECT item_uuid FROM Item WHERE item_code = %s", (item_number,))

    if existing_item:
        # 料號已存在，直接使用
        return existing_item['item_uuid']
    else:
        # 建立新品項
        item_uuid = str(uuid.uuid4())
        db.execute("""
            INSERT INTO Item (item_uuid, item_code, item_name_en, item_type, uom, project_code)
            VALUES (%s, %s, %s, %s, %s, 'EMU3000')
        """, (item_uuid, item_number, name, item_type, uom))
        return item_uuid
```

##### 裝備位置代碼提取

```python
def extract_equipment_location(notes):
    """從 Notes 欄位提取裝備位置代碼"""
    # 例如: "A01T0", "B50.20.03", "L05.L"
    if notes and isinstance(notes, str):
        # 移除空白並返回
        return notes.strip()
    return None
```

##### BOM 編號生成

```python
def generate_bom_code(equipment_code, maintenance_period, sheet_type):
    """生成 BOM 編號"""
    return f"EMU3000-{equipment_code}-{maintenance_period}M-{sheet_type}"

# 範例:
# "EMU3000-A01-96M-定檢件"
# "EMU3000-C20-60M-定更件"
```

---

### 階段四：資料驗證

#### 4.1 基本統計查詢

```sql
-- 1. 統計 EMU3000 品項數量
SELECT
    item_type,
    COUNT(*) AS count
FROM "Item"
WHERE project_code = 'EMU3000'
GROUP BY item_type
ORDER BY item_type;

-- 預期結果:
-- FG: ~150-200 (裝備)
-- RM: ~3,000-5,000 (零件)

-- 2. 統計各維護週期的 BOM 數量
SELECT
    maintenance_period,
    sheet_type,
    COUNT(*) AS count
FROM "BOM"
GROUP BY maintenance_period, sheet_type
ORDER BY maintenance_period, sheet_type;

-- 預期結果:
-- 60個月: 2個 (定更件1 + 定檢件1)
-- 72個月: 14個 (7個檔案 × 2)
-- 96個月: 100個 (50個檔案 × 2)
-- 192個月: 66個 (33個檔案 × 2)

-- 3. 統計 BOM_LINE 數量
SELECT COUNT(*) FROM "BOM_line"
WHERE bom_uuid IN (
    SELECT bom_uuid FROM "BOM"
    WHERE item_uuid IN (
        SELECT item_uuid FROM "Item" WHERE project_code = 'EMU3000'
    )
);

-- 預期結果: ~8,000-10,000 行
```

#### 4.2 資料完整性檢查

```sql
-- 1. 檢查孤立的 BOM（沒有對應的 Item）
SELECT b.bom_uuid, b.bom_code
FROM "BOM" b
LEFT JOIN "Item" i ON b.item_uuid = i.item_uuid
WHERE i.item_uuid IS NULL;

-- 預期結果: 0 行（沒有孤立記錄）

-- 2. 檢查孤立的 BOM_LINE（沒有對應的 BOM 或 Item）
SELECT bl.line_uuid
FROM "BOM_line" bl
LEFT JOIN "BOM" b ON bl.bom_uuid = b.bom_uuid
LEFT JOIN "Item" i ON bl.component_item_uuid = i.item_uuid
WHERE b.bom_uuid IS NULL OR i.item_uuid IS NULL;

-- 預期結果: 0 行（沒有孤立記錄）

-- 3. 檢查重複料號
SELECT item_code, COUNT(*) AS count
FROM "Item"
WHERE project_code = 'EMU3000'
GROUP BY item_code
HAVING COUNT(*) > 1;

-- 預期結果: 0 行（沒有重複）
```

#### 4.3 業務邏輯驗證

```sql
-- 1. 查詢某個裝備的所有零件（以 A01 為例）
SELECT
    bl.line_no AS part_no,
    i.item_code,
    i.item_name_en,
    bl.qty_per,
    bl.uom,
    bl.wec_code,
    bom.sheet_type,
    bom.maintenance_period
FROM "Item" equip
JOIN "BOM" bom ON equip.item_uuid = bom.item_uuid
JOIN "BOM_line" bl ON bom.bom_uuid = bl.bom_uuid
JOIN "Item" i ON bl.component_item_uuid = i.item_uuid
WHERE equip.item_code = 'EMU3000-A01'
  AND bom.sheet_type = '定檢件'
ORDER BY bl.line_no
LIMIT 10;

-- 2. 統計某個零件用在哪些裝備
SELECT DISTINCT
    equip.item_code AS equipment_code,
    equip.item_name_en AS equipment_name,
    bom.maintenance_period,
    bl.qty_per,
    bl.uom
FROM "Item" part
JOIN "BOM_line" bl ON part.item_uuid = bl.component_item_uuid
JOIN "BOM" bom ON bl.bom_uuid = bom.bom_uuid
JOIN "Item" equip ON bom.item_uuid = equip.item_uuid
WHERE part.item_code = 'II108258-FA'
ORDER BY equip.item_code;

-- 3. 統計各 WEC 代碼的零件數量
SELECT
    wec_code,
    COUNT(*) AS count
FROM "BOM_line"
WHERE wec_code IS NOT NULL
GROUP BY wec_code
ORDER BY wec_code;
```

---

## 📊 預期資料量

| 項目 | 數量估計 | 資料庫表 |
|-----|---------|---------|
| **裝備（FG）** | 150-200 | Item + Item_Equipment_Ext |
| **零件（RM）** | 3,000-5,000 | Item |
| **BOM版本** | 180 | BOM |
| **BOM明細行** | 8,000-10,000 | BOM_LINE |
| **資料庫空間** | 50-100 MB | - |

---

## ⚠️ 注意事項與風險

### 風險1: 料號重複

**問題**: EMU3000 的料號可能與海軍裝備重複

**對策**:
- 採用智能重複檢查邏輯
- 如果料號和名稱都相同，共用同一個 Item
- 如果料號相同但名稱不同，加後綴區分

### 風險2: 編碼問題

**問題**: Excel 檔案可能包含 Big5 編碼的中文

**對策**:
- 使用 `pd.read_excel()` 並指定 `engine='openpyxl'`
- 資料庫連線使用 UTF-8 編碼

### 風險3: 檔案格式不一致

**問題**: 發現 8 個檔案格式異常

**對策**:
- 在導入前先檢查欄位名稱
- 對於異常檔案，手動修正或跳過
- 記錄失敗檔案清單

### 風險4: 交易過大

**問題**: 一次導入太多資料可能導致交易超時

**對策**:
- 分批次導入（每個維護週期提交一次）
- 使用批次插入（每 100 筆提交一次）

---

## 🔧 常見問題排除

### Q1: 資料庫連線失敗

**錯誤訊息**: `could not connect to server`

**解決方法**:
1. 檢查 PostgreSQL 服務是否啟動
2. 檢查連線參數（host, port, database, user, password）
3. 檢查防火牆設定

### Q2: 欄位不存在

**錯誤訊息**: `column "project_code" does not exist`

**解決方法**:
- 執行 `alter_database_for_emu3000.sql` 腳本

### Q3: 外鍵約束錯誤

**錯誤訊息**: `insert or update on table "BOM_line" violates foreign key constraint`

**解決方法**:
- 確保先插入 Item 和 BOM，再插入 BOM_LINE
- 檢查 UUID 是否正確

### Q4: 重複鍵錯誤

**錯誤訊息**: `duplicate key value violates unique constraint`

**解決方法**:
- 檢查料號是否已存在
- 使用 `ON CONFLICT DO NOTHING` 或先查詢再插入

---

## 📝 操作檢查清單

### 導入前檢查

- [ ] 資料庫已建立（sbir_equipment_db_v2）
- [ ] 已執行 `alter_database_for_emu3000.sql`
- [ ] 已安裝 Python 依賴套件（pandas, openpyxl, psycopg2）
- [ ] Excel 檔案路徑正確
- [ ] 資料庫連線正常

### 導入中檢查

- [ ] 監控導入進度
- [ ] 記錄錯誤訊息
- [ ] 檢查記憶體使用量
- [ ] 定期檢查資料庫大小

### 導入後檢查

- [ ] 執行統計查詢驗證資料量
- [ ] 執行完整性檢查（孤立記錄、外鍵）
- [ ] 執行業務邏輯驗證
- [ ] 備份資料庫

---

## 🎯 成功標準

### 資料量標準

- [x] Item (FG): 150-200 個
- [x] Item (RM): 3,000-5,000 個
- [x] BOM: ~180 個
- [x] BOM_LINE: 8,000-10,000 行

### 資料品質標準

- [x] 無孤立記錄（外鍵完整性）
- [x] 無重複料號
- [x] 所有 UUID 格式正確
- [x] project_code = 'EMU3000' 的記錄數正確

### 業務邏輯標準

- [x] 可以查詢某個裝備的所有零件
- [x] 可以查詢某個零件用在哪些裝備
- [x] 可以按維護週期統計零件數量
- [x] 可以按 WEC 代碼分類零件

---

## 📞 聯絡資訊

如有問題或需要協助，請聯絡：

- **專案負責人**: SBIR 專案團隊
- **技術支援**: 參考 `Database/docs/` 目錄的相關文件

---

**文件版本**: 1.0
**最後更新**: 2025-11-24
