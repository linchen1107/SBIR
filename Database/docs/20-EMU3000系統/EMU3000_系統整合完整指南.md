# EMU3000 維修物料清單系統整合完整指南

## 📋 文件資訊

- **文件名稱**: EMU3000 維修物料清單系統整合完整指南
- **專案**: SBIR 通用型裝備資料庫（台鐵 EMU3000 + 海軍裝備）
- **版本**: 2.0（統整版）
- **建立日期**: 2025-11-24
- **維護單位**: SBIR 專案團隊
- **資料來源**: 台鐵 EMU3000 電聯車原廠維修物料清單
- **目標資料庫**: sbir_equipment_db_v2

---

## 📑 目錄

- [一、專案概述](#一專案概述)
- [二、資料來源與結構](#二資料來源與結構)
- [三、資料驗證結果](#三資料驗證結果)
- [四、資料庫整合方案](#四資料庫整合方案)
- [五、資料導入實施](#五資料導入實施)
- [六、操作指南與注意事項](#六操作指南與注意事項)
- [附錄 A：完整檔案清單](#附錄-a完整檔案清單)
- [附錄 B：裝備代碼索引](#附錄-b裝備代碼索引)
- [附錄 C：實際資料範例](#附錄-c實際資料範例)

---

## 一、專案概述

### 1.1 專案目標

將台鐵 EMU3000 電聯車的維修物料清單整合到現有的 **V3.0 資料庫架構**中，與海軍裝備資料共用同一資料庫，實現通用型裝備資料庫的建置目標。

### 1.2 EMU3000 簡介

**EMU3000 通勤電聯車**是台灣鐵路管理局採購的第三代電聯車（Electric Multiple Unit），主要用於西部幹線的通勤運輸服務。這批檔案是原廠（KNORR-BREMSE、日本車輛等）提供的**維修保養物料清單**（Maintenance Parts List），詳細列出列車在不同保養週期需要更換或檢查的零組件。

### 1.3 資料規模

| 項目 | 數量 | 說明 |
|-----|------|------|
| **總檔案數** | 91 個 | Excel 格式（.xlsx）|
| **裝備/系統數** | 49 個 | 獨立的裝備或子系統 |
| **維護週期** | 5 種 | 60/72/96/192/240 個月 |
| **工作表類型** | 2 種 | 定更件 + 定檢件 |
| **總零件數** | 估計 3,000-5,000 | 跨所有檔案 |
| **資料完整度** | ~91% | 檔案格式正常的比例 |

### 1.4 相關文件

| 文件名稱 | 說明 | 位置 |
|---------|------|------|
| **EMU3000_系統整合完整指南.md** | 本文件（統整版） | `Database/docs/20-EMU3000系統/` |
| **01-EMU3000_維修物料清單說明.md** | 詳細資料結構說明 | `Database/docs/20-EMU3000系統/` |
| **02-EMU3000_資料驗證報告.md** | 資料驗證結果 | `Database/docs/20-EMU3000系統/` |
| **03-EMU3000_導入操作指南.md** | 操作步驟指南 | `Database/docs/20-EMU3000系統/` |
| **alter_database_for_emu3000.sql** | 資料庫結構調整腳本 | `Database/scripts/` |
| **import_emu3000_data.py** | 資料導入腳本 | `Database/scripts/` |

---

## 二、資料來源與結構

### 2.1 檔案組織結構

#### 資料來源路徑

```
c:/github/SBIR/Database/data/EMU3000/EMU 3000 維修物料清單/
├── 5年維護（60個月）/
│   └── 01 清潔塊單元--C20、C21--OK/
├── 6年維護（72個月）/
│   ├── 01 剎車鉗單元--C06、C07--OK/
│   ├── 02 遙控--C13--OK/
│   └── 03 汽笛--P04、P05--OK/
├── 8年維護（96個月）/  ⭐ 最多檔案
│   ├── 01 空氣供應單元--A01--OK/
│   ├── 02 壓縮機組--A01.01--OK/
│   └── ... (共42個子目錄)
├── 16年維護（192個月）/
│   ├── 01 浮球閥--A02、A05、...--OK/
│   └── 02 測試接頭--A01.07、B14、.../
└── 20年維護（240個月）/
    └── 01 電路板--B50.20.02.003/  (⚠️ 無檔案)
```

#### 維護週期分布

| 維護週期 | 月數 | 裝備數 | 檔案數 | 佔比 | 說明 |
|---------|------|--------|--------|------|------|
| 5年維護 | 60 | 1 | 1 | 1.1% | 最耐用裝備（清潔塊單元）|
| 6年維護 | 72 | 3 | 7 | 7.7% | 煞車系統為主 |
| **8年維護** | **96** | **42** | **50** | **54.9%** | 🔥 **主要保養週期** |
| 16年維護 | 192 | 2 | 33 | 36.3% | 浮球閥為主 |
| 20年維護 | 240 | 1 | 0 | 0% | 電子零件（待補充）|
| **總計** | - | **49** | **91** | **100%** | - |

---

### 2.2 Excel 檔案結構

#### 工作表組成

每個 Excel 檔案包含 **2 個工作表**：

**工作表 1：定更件（Scheduled Replacement Parts）**
- 用途：到達維護週期時**必須強制更換**的零件清單
- 更換原因：密封圈、墊片、濾芯、油品、安全閥彈簧等會老化或耗損的零件

**工作表 2：定檢件（Scheduled Inspection Parts）**
- 用途：到達維護週期時**必須檢查，視狀況決定**是否更換的零件清單
- 檢查對象：結構件、管路、接頭、電氣組件、機械傳動件

#### 欄位結構

| 英文欄位名 | 中文說明 | 資料類型 | 範例 | 說明 |
|-----------|---------|---------|------|------|
| **Part** | 零件序號 | INT / FLOAT | 1, 2, 3, ... | **有此欄位的行才是實際零件** |
| **Item number** | 料號 / P/N | VARCHAR | II108258-FA<br>8.181.2.321.173.9 | 零件料號（Part Number）|
| **Quantity** | 數量 | INT / FLOAT | 1, 2, 6 | 每次維護需要的數量 |
| **Unit** | 單位 | VARCHAR | Pce (件)<br>Set (組)<br>Lot (批) | 計量單位 |
| **Name** | 名稱 | VARCHAR | FRAME<br>COMPRESSOR SET | 零件英文名稱 |
| **WEC** | WEC代碼 | VARCHAR | A, B, C, D | Work Element Code（工作要素代碼）|
| **Notes** | 備註 | VARCHAR | A01T0, B50.20.03 | **裝備位置代碼** |
| **Kit No** | 套件號 | VARCHAR | - | 套件編號（組套零件編號）|
| **Part is contained in** | 包含於 | VARCHAR | - | 上層組件資訊 |

#### 資料層級結構（BOM 樹狀結構）

```
行1: [無Part] 11108258 - AIR SUPPLY UNIT - Notes: A01T0  ← 頂層裝備資訊
行2: Part 1    II108258-FA - FRAME - 1 Pce               ← 第一個零件
行3: Part 2    8.181.2.321.173.9 - COMPRESSOR SET - 1 Pce ← 第二個零件
行4: Part 3    11111516 - AIR DRYER UNIT - 1 Pce         ← 第三個零件
...
行n: [無Part] II108258-FA - FRAME - Notes: A01T1         ← 下一個裝備位置
行n+1: Part 1  C96563/4 - PIPE CLIP - 2 Pce              ← 該位置的零件
...
```

**重要規則**：
- **有 Part 編號的行** = 實際零件
- **沒有 Part 編號的行** = 裝備名稱或分類標題
- **Notes 欄位** = 標識該零件屬於哪個裝備位置（如 A01T0）

---

### 2.3 裝備代碼系統

#### 代碼結構

```
格式：[主代碼].[子代碼].[孫代碼].[曾孫代碼][位置後綴]
```

**範例 1：簡單代碼**
```
A01              ← 第一層：主系統（空氣供應單元）
 ├─ A01.01       ← 第二層：子系統（壓縮機組）
 ├─ A01.04       ← 第二層：子系統（空氣乾燥單元）
 └─ A01.06       ← 第二層：子系統（安全閥）
```

**範例 2：複雜代碼**
```
B50.20                      ← 第二層：煞車容器
 ├─ B50.20.01               ← 第三層：EP COMPACT
 │   └─ B50.20.01.01        ← 第四層：EP COMPACT 子模組
 │       ├─ B50.20.01.01.001  ← 第五層：煞車控制模組 001
 │       └─ B50.20.01.01.002  ← 第五層：煞車控制模組 002
 └─ B50.20.03               ← 第三層：PLUSMODULE
     ├─ B50.20.03.04        ← 第四層：壓力感測器
     └─ B50.20.03.05        ← 第四層：電磁閥
```

#### 主代碼分類

| 代碼前綴 | 系統分類 | 英文全稱 | 說明 |
|---------|---------|---------|------|
| **A** | 氣動系統 | Air System | 空氣供應、壓縮機、乾燥器 |
| **B** | 煞車系統 | Brake System | 煞車控制、氣動元件、電控模組 |
| **C** | 煞車鉗/控制 | Caliper / Control | 煞車鉗、清潔單元、控制面板 |
| **D** | 駕駛控制 | Driver Control | 駕駛員操作裝置、儀表 |
| **G** | 防滑系統 | WSP (Wheel Slip Protection) | 防滑閥、輪滑偵測 |
| **L** | 水平閥 | Leveling Valve | 車輛高度調節系統 |
| **N** | 緊急/警示 | Emergency / Notification | 緊急煞車、警醒裝置 |
| **P** | 氣動附件 | Pneumatic | 管路過濾器、汽笛 |
| **T** | 廁所系統 | Toilet | 廁所相關裝備 |
| **U** | 公用設施 | Utility | 輔助系統、備用設備 |

#### 位置後綴編碼

| 後綴格式 | 說明 | 範例 | 用途 |
|---------|------|------|------|
| **T0-T33** | 裝備編號 | A01T0, A01T1, A01T33 | 同一裝備在不同位置的編號（Train 0-33）|
| **.L** | 左側 | A05.L, L05.L | 左側裝備（Left）|
| **.R** | 右側 | A05.R, L05.R | 右側裝備（Right）|
| **.1, .2** | 第一、第二個 | A05.1, B42.1 | 同一位置的多個裝備 |
| **_E** | 端車 | B22_E, B41_E | 端車位置（End car）|
| **.M** | 動車 | G01.M | 動力車廂（Motor car）|
| **.T** | 拖車 | G01.T | 無動力車廂（Trailer car）|
| **xx** | 通配符 | Bxx.10.01, B5x.20.03 | 代表多個類似位置 |

#### WEC 代碼

| WEC | 說明 | 用途 |
|-----|------|------|
| **A** | 拆卸後必須更換 | Must always be replaced upon removal |
| **B** | 每次大修必須更換 | Must be replaced at every overhaul |
| **C** | 磨損嚴重時更換或修復 | Replace/recondition if worn severely |
| **D** | 每次保養和大修都必須更換 | Must be replaced at each servicing and overhaul |

**註**：實際資料中目前只發現 A、B、C 三種代碼，D 代碼未使用。

---

### 2.4 維護週期詳解

#### 2.4.1 五年維護（60個月）

| 裝備代碼 | 裝備名稱 | 檔案數 | 用途說明 |
|---------|---------|--------|----------|
| C20、C21 | 清潔塊單元<br>CLEAN. BLOCK UNIT | 1 | 車廂廁所清潔系統的關鍵組件 |

**特點**：最長保養週期，只有耐用性極高的裝備才會放在此週期。

---

#### 2.4.2 六年維護（72個月）

| 裝備代碼 | 裝備名稱 | 檔案數 | 用途說明 |
|---------|---------|--------|----------|
| C06、C07 | 煞車鉗單元<br>BRAKE CALIPER UNIT | 3 | 列車制動系統 |
| C13 | 遙控<br>REMOTE CONTROL | 1 | 煞車遠端控制裝置 |
| P04、P05 | 汽笛<br>HORN | 3 | 列車警示音響系統 |

**特點**：主要是煞車相關系統，安全性要求高但磨損較慢。

---

#### 2.4.3 八年維護（96個月）⭐ 主要保養週期

這是**最主要的保養週期**，涵蓋列車的核心系統，共 **42 個裝備、50 個檔案**。

##### 氣動系統（Air System）

| 裝備代碼 | 裝備名稱 | 檔案數 | 零件數 | 說明 |
|---------|---------|--------|--------|------|
| **A01** | **空氣供應單元** | 1 | **921** | 🔥 最複雜系統，包含 34 個裝備位置 |
| A01.01 | 壓縮機組 | 1 | ~300 | A01 的子系統 |
| A01.04 | 空氣乾燥單元 | 1 | ~200 | 去除壓縮空氣中的水分 |
| A01.06 | 安全閥 | 1 | ~10 | 壓力保護裝置 |
| D03, B50.01, B50.02 | 空氣過濾器 | 3 | ~50 | 過濾空氣中的雜質 |
| U01 | 空氣供應單元 | 1 | ~200 | 備用/附屬空氣系統 |

##### 煞車系統（Brake System）

| 裝備代碼 | 裝備名稱 | 檔案數 | 說明 |
|---------|---------|--------|------|
| **B50.20** | **煞車容器** | 1 | 氣壓儲存容器（複雜系統）|
| B50.20.01 | EP COMPACT | 1 | 電控氣動煞車模組 |
| B50.20.03 | PLUSMODULE | 1 | 電控模組 |
| B50.10 | 輔助控制單元 | 1 | 煞車電控單元 |
| B50.30 | 分配閥 | 1 | 煞車力分配 |
| C11、C12 | 踏面煞車單元 | 2 | 輪軌摩擦煞車裝置 |
| G01 | 防滑閥 | 2 | 防止煞車時車輪鎖死（WSP）|

##### 駕駛控制系統（Driver Control）

| 裝備代碼 | 裝備名稱 | 檔案數 | 說明 |
|---------|---------|--------|------|
| D07 | 活塞閥 | 1 | 氣動控制閥 |
| D10-D13 | 壓力計 | 5 | 顯示各系統氣壓值 |
| D15-D18, B32 | 節流閥 | 5 | 氣流速度控制 |

##### 安全與緊急系統

| 裝備代碼 | 裝備名稱 | 檔案數 | 說明 |
|---------|---------|--------|------|
| N02 | 緊急煞車閥 | 1 | 緊急制動啟動裝置 |
| N05 | 警醒裝置閥 | 1 | 駕駛員警示系統（Dead Man's Pedal）|
| U07 | 腳踏泵 | 1 | 備用氣壓泵 |

**特點總結**：
- 包含列車**所有核心系統**
- 佔總檔案數的 **54.9%**
- 最複雜的系統（A01）包含 **921 行零件**
- 涵蓋**氣動、煞車、控制、安全**四大類

---

#### 2.4.4 十六年維護（192個月）

| 裝備代碼 | 裝備名稱 | 檔案數 | 說明 |
|---------|---------|--------|------|
| **26個位置** | **浮球閥** | **31** | 🔥 分布全車各車廂<br>廁所、水箱的水位控制閥 |
| 6個位置 | 測試接頭 | 2 | 維修測試用接頭 |

**浮球閥位置包括**：
- A02, A05 (L/R/1), A10 (L/R)
- B13 (L/R/1), B22-B25 (E), B31 (E)
- B40 (L/R), B41 (E), B42 (E/1)
- Bxx.10.01/02/03, Bxx.20.03.01/02
- D04 (1), D19 (L/R), D20 (L/R)
- L03 (L/R), N04 (1), P01, T01
- U05, U11

**特點**：
- 這些零件**非常耐用**，每 16 年才需要更換
- 浮球閥分布在**整個列車的各個車廂**
- 佔總檔案數的 **36.3%**

---

#### 2.4.5 二十年維護（240個月）

| 裝備代碼 | 裝備名稱 | 檔案數 | 說明 |
|---------|---------|--------|------|
| B50.20.02.003 | 電路板 | 0 | ⚠️ 目前沒有檔案（待補充）|

**特點**：最長保養週期（20年），電子零件壽命設計 20 年，目前資料待補充。

---

## 三、資料驗證結果

### 3.1 檔案數量驗證

| 維護週期 | 文件記錄 | 實際檔案數 | 驗證結果 |
|---------|---------|-----------|---------|
| 5年(60個月) | 1 | 1 | ✅ 正確 |
| 6年(72個月) | 7 | 7 | ✅ 正確 |
| 8年(96個月) | 50 | 50 | ✅ 正確 |
| 16年(192個月) | 33 | 33 | ✅ 正確 |
| 20年(240個月) | 0 | 0 | ✅ 正確 |
| **總計** | **91** | **91** | ✅ **完全一致** |

**結論**: 文件中的檔案數量統計 100% 正確！

---

### 3.2 Excel 檔案結構驗證

#### 工作表驗證

✅ **正確**：每個 Excel 檔案包含 **2 個工作表**（定更件 + 定檢件）

#### 欄位驗證

所有欄位與文件描述完全一致：
- ✅ Part（零件序號）
- ✅ Item number（料號）
- ✅ Quantity（數量）
- ✅ Unit（單位）
- ✅ Name（名稱）
- ✅ WEC（工作要素代碼）
- ✅ Notes（裝備位置）
- ✅ Kit No（套件編號）
- ✅ Part is contained in（上層組件）

#### WEC 代碼驗證

從實際資料中統計到的 WEC 代碼：
- **A**: 拆卸後必須更換
- **B**: 每次大修必須更換
- **C**: 磨損嚴重時更換或修復

**注意**：文件中提到的 **D** 代碼（每次保養和大修都必須更換）在目前資料中未出現。

---

### 3.3 資料範例驗證

#### 範例 1：清潔塊單元（60個月）✅

**實際資料**：
```
Row 0: Part=NaN, Item number=II73643/4WU, Name=CLEAN. BLOCK UNIT 清潔塊單元, Notes=C20T0
Row 1: Part=1.0, Item number=C147356/WU, Name=HOUSING, WEC=C
Row 2: Part=2.0, Item number=C105792/WU, Name=GUIDE COVER, WEC=C
```
**結論**: ✅ 與文件描述完全一致

#### 範例 2：浮球閥--A02（192個月）✅

**實際資料**：
```
Row 0: Part=NaN, Item number=II50172/2A1R, Name=BALLCOCK, Notes=A02T0
Row 1: Part=8.0, Item number=C103832/A, Name=T-HANDLE, Quantity=1.0
```
**結論**: ✅ 與文件描述完全一致

#### 範例 3：A01 空氣供應單元（96個月）✅

**實際資料**：
```
Total rows: 921
Row 0: Part=nan, Item number=11108258, Name=AIR SUPPLY UNIT, Notes=A01T0
Row 1: Part=7.0, Item number=478610, Name=WASHER
```
**結論**: ✅ 檔案結構與文件描述完全一致

---

### 3.4 發現的問題

#### 問題 1：部分檔案格式異常

以下檔案無法正常讀取 `Part` 欄位：

**6年維護（2個檔案）**：
- `煞車鉗單元C07、C07大修料件清單--72個月.xlsx`
- `03 汽笛--P04、P05.xlsx`

**16年維護（6個檔案）**：
- `浮球閥B22_E-II50175-1A1RE_04-EN.xlsx`
- `浮球閥B23_E-II50176-1A1RE_03-EN.xlsx`
- `浮球閥B24_E-II50175-1A1LE_03-EN.xlsx`
- `浮球閥B25_E-II50176-1A1LE_03-EN.xlsx`
- `浮球閥B31_E-II50175-1A1RE_04-EN.xlsx`
- `測試接頭A01.07.xlsx`

**原因**: 這些檔案的欄位名稱可能不同，或者格式有差異

**建議**: 在資料導入前先檢查這些檔案的格式並進行修正

#### 問題 2：缺失檔案清單

以下目錄存在但**沒有 Excel 檔案**（需要補充）：

| 維護週期 | 裝備名稱 | 裝備代碼 | 重要性 |
|---------|---------|---------|--------|
| 8年 | 角旋塞 | B26、B27 | 中 |
| 8年 | 煞車控制模組 | - | 🔥 高（安全相關）|
| 8年 | 溢流閥 | Bxx.05 | 中 |
| 8年 | 煞車控制模組 | B50.20.01.01.001/002 | 🔥 高（安全相關）|
| 8年 | 駕駛員的煞車閥 | D01 | 🔥 高（安全相關）|
| 8年 | 緊急煞車拉線箱 | N01 | 🔥 高（安全相關）|
| 8年 | 壓力開關 | U01.05 | 中 |
| 8年 | 電磁閥 | B50.20.03.05 | 中 |
| 8年 | 壓力調節器 | - | 中 |
| 20年 | 電路板 | B50.20.02.003 | 高 |

**建議**：優先補充**安全相關**的缺失檔案。

---

### 3.5 資料品質評估

#### ✅ 優點

1. **覆蓋完整**：91 個檔案涵蓋列車主要系統
2. **結構一致**：所有檔案使用相同的格式（2個工作表，相同欄位）
3. **詳細度高**：最複雜的系統（A01）包含 921 行零件資料
4. **階層清晰**：裝備代碼採用階層式編碼，易於管理
5. **文件準確**：文件內容與實際資料 100% 一致

#### ⚠️ 需要注意

1. **檔案格式不一致**：約 8 個檔案（8.8%）格式異常
2. **缺失檔案**：約 10 個目錄（20%）沒有檔案
3. **文件標記**：部分檔案標記「缺文件」，可能影響維修作業
4. **編碼複雜**：裝備代碼系統複雜，需要完整的編碼索引

#### 總體評估

| 項目 | 評分 | 說明 |
|-----|------|------|
| **文件準確度** | 100% | 文件與實際資料完全一致 |
| **資料完整度** | 91% | 83/91 檔案格式正常 |
| **資料一致性** | 100% | 結構完全統一 |
| **可導入性** | 高 | 現有資料庫結構完全支援 |

---

## 四、資料庫整合方案

### 4.1 現有資料庫結構

**sbir_equipment_db_v2** 資料庫採用 V3.0 架構，核心特點：

| 表名 | 用途 | 主鍵 | 說明 |
|-----|------|-----|------|
| **Item** | 品項主檔 | item_uuid (UUID) | 統一管理 FG/SEMI/RM |
| **Item_Equipment_Ext** | 裝備擴展表 | item_uuid | FG 類型專用欄位 |
| **Item_Material_Ext** | 料件擴展表 | item_uuid | SEMI/RM 類型專用欄位 |
| **BOM** | BOM 主表 | bom_uuid (UUID) | 版本控制 |
| **BOM_LINE** | BOM 明細行 | line_uuid (UUID) | Item 自我關聯 |
| **Part_Number_xref** | 零件號碼關聯 | part_number_id | 料號-廠商關聯 |
| **MRC** | 品項規格表 | mrc_uuid (UUID) | 規格資料 |
| **Supplier** | 供應商 | supplier_id | 廠商資料 |

**架構特點**：
- Item 自我參照 BOM 結構（多層次階層）
- UUID 主鍵用於核心表
- 擴展表模式（減少 NULL 欄位）
- BOM 版本控制與歷史追蹤

---

### 4.2 需要新增的欄位

#### 4.2.1 Item 表

```sql
ALTER TABLE "Item" ADD COLUMN project_code VARCHAR(20);
COMMENT ON COLUMN "Item".project_code IS '專案代碼: NAVY/EMU3000/...';
CREATE INDEX idx_item_project ON "Item"(project_code);
```

**用途**：區分海軍裝備（NAVY）與台鐵裝備（EMU3000）

#### 4.2.2 BOM 表

```sql
ALTER TABLE "BOM" ADD COLUMN sheet_type VARCHAR(20);
COMMENT ON COLUMN "BOM".sheet_type IS '工作表類型: 定更件/定檢件';

ALTER TABLE "BOM" ADD COLUMN maintenance_period INT;
COMMENT ON COLUMN "BOM".maintenance_period IS '維護週期（月數）: 60/72/96/192/240';

CREATE INDEX idx_bom_sheet_type ON "BOM"(sheet_type);
CREATE INDEX idx_bom_maintenance_period ON "BOM"(maintenance_period);
```

**用途**：記錄維護週期和工作表類型

#### 4.2.3 BOM_LINE 表

```sql
ALTER TABLE "BOM_line" ADD COLUMN kit_no VARCHAR(50);
COMMENT ON COLUMN "BOM_line".kit_no IS '套件編號';

ALTER TABLE "BOM_line" ADD COLUMN wec_code VARCHAR(5);
COMMENT ON COLUMN "BOM_line".wec_code IS 'WEC代碼: A/B/C/D';

CREATE INDEX idx_bom_line_wec ON "BOM_line"(wec_code);
```

**用途**：記錄套件編號和 WEC 代碼

#### 4.2.4 Item_Equipment_Ext 表

```sql
ALTER TABLE "Item_Equipment_Ext" ADD COLUMN equipment_location VARCHAR(50);
COMMENT ON COLUMN "Item_Equipment_Ext".equipment_location IS '裝備位置代碼: A01T0, A05.L 等';

CREATE INDEX idx_equip_ext_location ON "Item_Equipment_Ext"(equipment_location);
```

**用途**：記錄裝備在列車上的實際安裝位置

#### 4.2.5 新建 WEC_Code 表

```sql
CREATE TABLE WEC_Code (
    wec_code VARCHAR(5) PRIMARY KEY,
    description_en TEXT,
    description_zh TEXT
);

-- 插入 WEC 代碼定義
INSERT INTO WEC_Code VALUES
('A', 'Must always be replaced upon removal', '拆卸後必須更換'),
('B', 'Must be replaced at every overhaul', '每次大修必須更換'),
('C', 'Replace/recondition if worn severely', '磨損嚴重時更換或修復'),
('D', 'Must be replaced at each servicing and overhaul', '每次保養和大修都必須更換');
```

**用途**：WEC 代碼說明表

---

### 4.3 資料映射關係

#### 4.3.1 裝備層級（成品 FG）

| EMU3000 資料 | 資料庫表 | 資料庫欄位 | 範例值 | 說明 |
|-------------|---------|-----------|--------|------|
| **裝備資訊** | | | | |
| AIR SUPPLY UNIT | Item | item_name_en | AIR SUPPLY UNIT | 英文名稱 |
| 空氣供應單元 | Item | item_name_zh | 空氣供應單元 | 中文名稱 |
| A01 | Item | item_code | EMU3000-A01 | 裝備代碼（加前綴）|
| - | Item | item_type | FG | 成品類型 |
| EMU3000 | Item | project_code | EMU3000 | 專案代碼 |
| | | | | |
| **裝備擴展** | | | | |
| A01T0 | Item_Equipment_Ext | equipment_location | A01T0 | 裝備位置 |
| A01 | Item_Equipment_Ext | eswbs_code | A01 | 裝備分類碼 |
| 96個月 | Item_Equipment_Ext | maintenance_level | 96 | 維護等級 |
| | | | | |
| **BOM 版本** | | | | |
| 96個月 | BOM | bom_code | EMU3000-A01-96M-定檢件 | BOM 編號 |
| 定檢件 | BOM | sheet_type | 定檢件 | 工作表類型 |
| 96 | BOM | maintenance_period | 96 | 維護週期 |
| 1.0 | BOM | revision | 1.0 | 版本號 |

#### 4.3.2 零件層級（原物料 RM）

| EMU3000 資料 | 資料庫表 | 資料庫欄位 | 範例值 | 說明 |
|-------------|---------|-----------|--------|------|
| **零件資訊** | | | | |
| II108258-FA | Item | item_code | II108258-FA | 料號 |
| FRAME | Item | item_name_en | FRAME | 英文名稱 |
| - | Item | item_type | RM | 原物料類型 |
| EMU3000 | Item | project_code | EMU3000 | 專案代碼 |
| Pce | Item | uom | Pce | 基本單位 |
| | | | | |
| **BOM 清單** | | | | |
| Part 1 | BOM_LINE | line_no | 1 | 零件序號 |
| 1.0 | BOM_LINE | qty_per | 1.0000 | 數量 |
| Pce | BOM_LINE | uom | Pce | 用量單位 |
| C | BOM_LINE | wec_code | C | WEC 代碼 |
| (Kit No) | BOM_LINE | kit_no | - | 套件編號 |
| II108258-FA | BOM_LINE | component_item_uuid | (UUID) | 指向 Item 表 |

---

### 4.4 查詢範例

#### 查詢 1：取得 A01 空氣供應單元的所有零件

```sql
SELECT
    bl.line_no AS part_no,
    i.item_code,
    i.item_name_en,
    bl.qty_per,
    bl.uom,
    bl.wec_code,
    bom.sheet_type,
    bom.maintenance_period
FROM "Item" equip
JOIN "BOM" bom ON equip.item_uuid = bom.item_uuid
JOIN "BOM_line" bl ON bom.bom_uuid = bl.bom_uuid
JOIN "Item" i ON bl.component_item_uuid = i.item_uuid
WHERE equip.item_code = 'EMU3000-A01'
  AND equip.project_code = 'EMU3000'
  AND bom.sheet_type = '定檢件'
ORDER BY bl.line_no;
```

#### 查詢 2：統計 EMU3000 各維護週期的零件數量

```sql
SELECT
    bom.maintenance_period AS "維護週期（月）",
    bom.sheet_type AS "工作表類型",
    COUNT(DISTINCT equip.item_uuid) AS "裝備數量",
    COUNT(bl.line_uuid) AS "零件總數"
FROM "Item" equip
JOIN "BOM" bom ON equip.item_uuid = bom.item_uuid
JOIN "BOM_line" bl ON bom.bom_uuid = bl.bom_uuid
WHERE equip.project_code = 'EMU3000'
  AND equip.item_type = 'FG'
GROUP BY bom.maintenance_period, bom.sheet_type
ORDER BY bom.maintenance_period, bom.sheet_type;
```

#### 查詢 3：找出某個零件用在哪些裝備

```sql
SELECT DISTINCT
    equip.item_code AS "裝備代碼",
    equip.item_name_zh AS "裝備名稱",
    bom.maintenance_period AS "維護週期",
    bl.qty_per AS "用量",
    bl.uom AS "單位"
FROM "Item" part
JOIN "BOM_line" bl ON part.item_uuid = bl.component_item_uuid
JOIN "BOM" bom ON bl.bom_uuid = bom.bom_uuid
JOIN "Item" equip ON bom.item_uuid = equip.item_uuid
WHERE part.item_code = 'II108258-FA'
  AND part.project_code = 'EMU3000'
ORDER BY equip.item_code;
```

#### 查詢 4：統計各 WEC 代碼的零件數量

```sql
SELECT
    bl.wec_code,
    wec.description_zh AS "說明",
    COUNT(*) AS "零件數量"
FROM "BOM_line" bl
LEFT JOIN WEC_Code wec ON bl.wec_code = wec.wec_code
WHERE bl.bom_uuid IN (
    SELECT bom_uuid FROM "BOM"
    WHERE item_uuid IN (
        SELECT item_uuid FROM "Item" WHERE project_code = 'EMU3000'
    )
)
GROUP BY bl.wec_code, wec.description_zh
ORDER BY bl.wec_code;
```

---

## 五、資料導入實施

### 5.1 導入流程總覽

```
階段一：資料庫結構調整（1小時）
  → 執行 ALTER TABLE 語句
  → 建立索引
  → 驗證結構調整

階段二：測試導入（2-4小時）
  → 測試資料庫連線
  → 測試單一檔案導入
  → 驗證資料正確性

階段三：批次導入（1-2天）
  → 5年維護（1個檔案）
  → 6年維護（7個檔案）
  → 16年維護（33個檔案）
  → 8年維護（50個檔案）

階段四：資料驗證（4-8小時）
  → 統計查詢
  → 完整性檢查
  → 業務邏輯驗證
  → 產生驗證報告
```

---

### 5.2 階段一：資料庫結構調整

#### 步驟 1：執行結構調整腳本

```bash
PGPASSWORD=willlin07 "/c/Program Files/PostgreSQL/16/bin/psql.exe" \
  -U postgres \
  -h localhost \
  -p 5432 \
  -d sbir_equipment_db_v2 \
  -f "c:/github/SBIR/Database/scripts/alter_database_for_emu3000.sql"
```

#### 步驟 2：驗證結構調整

```sql
-- 檢查 Item 表的 project_code 欄位
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'Item' AND column_name = 'project_code';

-- 檢查 BOM 表的新欄位
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'BOM' AND column_name IN ('sheet_type', 'maintenance_period');

-- 檢查 WEC_Code 表
SELECT * FROM WEC_Code;
```

**預期結果**：所有欄位和表都已建立。

---

### 5.3 階段二：測試導入

#### 步驟 1：測試資料庫連線

```bash
cd c:/github/SBIR
python Database/scripts/import_emu3000_data.py
```

**預期輸出**:
```
INFO - EMU3000 資料導入程式
INFO - 資料庫連線成功！
INFO - ✓ 資料庫結構已更新（project_code 欄位存在）
INFO - 現有 EMU3000 品項數量: 0
```

#### 步驟 2：測試單一檔案導入

選擇最簡單的檔案進行測試：

**測試檔案**: `清潔塊單元C20、C21大修料件清單--60個月.xlsx`

使用 Python 腳本測試讀取：

```python
import pandas as pd

file_path = r'c:/github/SBIR/Database/data/EMU3000/EMU 3000 維修物料清單/5年維護/01 清潔塊單元--C20、C21--OK/清潔塊單元C20、C21大修料件清單--60個月.xlsx'

xls = pd.ExcelFile(file_path)
print(f'工作表: {xls.sheet_names}')

# 讀取定檢件
df = pd.read_excel(file_path, sheet_name='定檢件')
print(f'總行數: {len(df)}')
print(df.head(10))
```

#### 步驟 3：驗證測試結果

檢查資料是否正確導入：

```sql
-- 檢查裝備
SELECT * FROM "Item" WHERE project_code = 'EMU3000' AND item_type = 'FG';

-- 檢查零件
SELECT COUNT(*) FROM "Item" WHERE project_code = 'EMU3000' AND item_type = 'RM';

-- 檢查 BOM
SELECT * FROM "BOM" WHERE maintenance_period = 60;

-- 檢查 BOM_LINE
SELECT COUNT(*) FROM "BOM_line" WHERE bom_uuid IN (
    SELECT bom_uuid FROM "BOM" WHERE maintenance_period = 60
);
```

---

### 5.4 階段三：批次導入

#### 導入策略

**建議採用分階段導入**：

| 階段 | 維護週期 | 檔案數 | 預估時間 | 目的 |
|-----|---------|--------|---------|------|
| 1 | 5年（60M） | 1 | 30分鐘 | 驗證流程 |
| 2 | 6年（72M） | 7 | 2小時 | 小批次測試 |
| 3 | 16年（192M） | 33 | 4-6小時 | 中批次測試 |
| 4 | 8年（96M） | 50 | 8-12小時 | 大批次導入 |

#### 資料導入流程（每個檔案）

```
1. 讀取 Excel 檔案
   → 掃描工作表（定更件/定檢件）
   ↓
2. 解析裝備資訊（Part=NULL）
   → 提取裝備代碼、名稱、位置
   ↓
3. 建立裝備主檔
   → INSERT INTO Item (item_type='FG', project_code='EMU3000')
   → INSERT INTO Item_Equipment_Ext (equipment_location)
   ↓
4. 為每個工作表建立 BOM
   → INSERT INTO BOM (sheet_type, maintenance_period)
   ↓
5. 處理零件清單（Part!=NULL）
   → 檢查料號是否已存在
   → 如果不存在: INSERT INTO Item (item_type='RM')
   → INSERT INTO BOM_LINE (wec_code, kit_no)
   ↓
6. 提交交易
   → COMMIT
```

---

### 5.5 關鍵處理邏輯

#### 邏輯 1：料號唯一性處理

```python
def get_or_create_item(item_number, name, item_type, uom):
    """取得或建立品項"""

    # 檢查料號是否已存在
    existing_item = db.query(
        "SELECT item_uuid, item_name_en FROM \"Item\" WHERE item_code = %s",
        (item_number,)
    )

    if existing_item:
        # 料號已存在
        if existing_item['item_name_en'] == name:
            # 料號和名稱都相同，直接使用
            return existing_item['item_uuid']
        else:
            # 料號相同但名稱不同，加後綴區分
            new_item_code = f"{item_number}-EMU3000"
            return create_new_item(new_item_code, name, item_type, uom)
    else:
        # 建立新品項
        return create_new_item(item_number, name, item_type, uom)

def create_new_item(item_code, name, item_type, uom):
    """建立新品項"""
    item_uuid = str(uuid.uuid4())
    db.execute("""
        INSERT INTO "Item" (item_uuid, item_code, item_name_en, item_type, uom, project_code)
        VALUES (%s, %s, %s, %s, %s, 'EMU3000')
    """, (item_uuid, item_code, name, item_type, uom))
    return item_uuid
```

#### 邏輯 2：裝備位置代碼提取

```python
def extract_equipment_location(notes):
    """從 Notes 欄位提取裝備位置代碼"""
    # 例如: "A01T0", "B50.20.03", "L05.L"
    if notes and isinstance(notes, str):
        # 移除空白並返回
        return notes.strip()
    return None
```

#### 邏輯 3：BOM 編號生成

```python
def generate_bom_code(equipment_code, maintenance_period, sheet_type):
    """生成 BOM 編號"""
    return f"EMU3000-{equipment_code}-{maintenance_period}M-{sheet_type}"

# 範例:
# "EMU3000-A01-96M-定檢件"
# "EMU3000-C20-60M-定更件"
```

#### 邏輯 4：批次插入優化

```python
def batch_insert_items(items, batch_size=100):
    """批次插入品項"""
    for i in range(0, len(items), batch_size):
        batch = items[i:i+batch_size]

        # 準備批次資料
        values = [(
            item['uuid'],
            item['code'],
            item['name'],
            item['type'],
            item['uom'],
            'EMU3000'
        ) for item in batch]

        # 批次插入
        cursor.executemany("""
            INSERT INTO "Item" (item_uuid, item_code, item_name_en, item_type, uom, project_code)
            VALUES (%s, %s, %s, %s, %s, %s)
        """, values)

        # 提交
        conn.commit()
        print(f"已插入 {len(values)} 個品項")
```

---

### 5.6 階段四：資料驗證

#### 驗證 1：基本統計查詢

```sql
-- 1. 統計 EMU3000 品項數量
SELECT
    item_type,
    COUNT(*) AS count
FROM "Item"
WHERE project_code = 'EMU3000'
GROUP BY item_type
ORDER BY item_type;

-- 預期結果:
-- FG: ~150-200 (裝備)
-- RM: ~3,000-5,000 (零件)

-- 2. 統計各維護週期的 BOM 數量
SELECT
    maintenance_period,
    sheet_type,
    COUNT(*) AS count
FROM "BOM"
GROUP BY maintenance_period, sheet_type
ORDER BY maintenance_period, sheet_type;

-- 預期結果:
-- 60個月: 2個 (定更件1 + 定檢件1)
-- 72個月: 14個 (7個檔案 × 2)
-- 96個月: 100個 (50個檔案 × 2)
-- 192個月: 66個 (33個檔案 × 2)

-- 3. 統計 BOM_LINE 數量
SELECT COUNT(*) FROM "BOM_line"
WHERE bom_uuid IN (
    SELECT bom_uuid FROM "BOM"
    WHERE item_uuid IN (
        SELECT item_uuid FROM "Item" WHERE project_code = 'EMU3000'
    )
);

-- 預期結果: ~8,000-10,000 行
```

#### 驗證 2：資料完整性檢查

```sql
-- 1. 檢查孤立的 BOM（沒有對應的 Item）
SELECT b.bom_uuid, b.bom_code
FROM "BOM" b
LEFT JOIN "Item" i ON b.item_uuid = i.item_uuid
WHERE i.item_uuid IS NULL;

-- 預期結果: 0 行（沒有孤立記錄）

-- 2. 檢查孤立的 BOM_LINE（沒有對應的 BOM 或 Item）
SELECT bl.line_uuid
FROM "BOM_line" bl
LEFT JOIN "BOM" b ON bl.bom_uuid = b.bom_uuid
LEFT JOIN "Item" i ON bl.component_item_uuid = i.item_uuid
WHERE b.bom_uuid IS NULL OR i.item_uuid IS NULL;

-- 預期結果: 0 行（沒有孤立記錄）

-- 3. 檢查重複料號
SELECT item_code, COUNT(*) AS count
FROM "Item"
WHERE project_code = 'EMU3000'
GROUP BY item_code
HAVING COUNT(*) > 1;

-- 預期結果: 0 行（沒有重複）
```

#### 驗證 3：業務邏輯驗證

```sql
-- 1. 查詢某個裝備的所有零件（以 A01 為例）
SELECT
    bl.line_no AS part_no,
    i.item_code,
    i.item_name_en,
    bl.qty_per,
    bl.uom,
    bl.wec_code,
    bom.sheet_type
FROM "Item" equip
JOIN "BOM" bom ON equip.item_uuid = bom.item_uuid
JOIN "BOM_line" bl ON bom.bom_uuid = bl.bom_uuid
JOIN "Item" i ON bl.component_item_uuid = i.item_uuid
WHERE equip.item_code = 'EMU3000-A01'
  AND bom.sheet_type = '定檢件'
ORDER BY bl.line_no
LIMIT 10;

-- 2. 統計某個零件用在哪些裝備
SELECT DISTINCT
    equip.item_code AS equipment_code,
    equip.item_name_en AS equipment_name,
    bom.maintenance_period,
    bl.qty_per,
    bl.uom
FROM "Item" part
JOIN "BOM_line" bl ON part.item_uuid = bl.component_item_uuid
JOIN "BOM" bom ON bl.bom_uuid = bom.bom_uuid
JOIN "Item" equip ON bom.item_uuid = equip.item_uuid
WHERE part.item_code = 'II108258-FA'
ORDER BY equip.item_code;
```

---

### 5.7 預期資料量

| 項目 | 數量估計 | 資料庫表 | 說明 |
|-----|---------|---------|------|
| **裝備（FG）** | 150-200 | Item + Item_Equipment_Ext | 49 個裝備 × 平均 3-4 個位置 |
| **零件（RM）** | 3,000-5,000 | Item | 91 個檔案 × 平均 50-100 個零件 |
| **BOM版本** | 180 | BOM | 91 個檔案 × 2 個工作表 |
| **BOM明細行** | 8,000-10,000 | BOM_LINE | 零件數 × 平均出現次數 |
| **資料庫空間** | 50-100 MB | - | 包含索引 |

**資料庫容量分析**：
- Item 表：~5,150 行 × 1 KB = ~5 MB
- BOM 表：~180 行 × 0.5 KB = ~0.1 MB
- BOM_LINE 表：~10,000 行 × 0.5 KB = ~5 MB
- 索引：~10-20 MB

---

## 六、操作指南與注意事項

### 6.1 操作檢查清單

#### 導入前檢查

- [ ] 資料庫已建立（sbir_equipment_db_v2）
- [ ] 已執行 `alter_database_for_emu3000.sql`
- [ ] 已安裝 Python 依賴套件（pandas, openpyxl, psycopg2）
- [ ] Excel 檔案路徑正確
- [ ] 資料庫連線正常
- [ ] 已備份現有資料庫

#### 導入中檢查

- [ ] 監控導入進度（Console 輸出）
- [ ] 記錄錯誤訊息（日誌檔案）
- [ ] 檢查記憶體使用量
- [ ] 定期檢查資料庫大小
- [ ] 監控資料庫連線數

#### 導入後檢查

- [ ] 執行統計查詢驗證資料量
- [ ] 執行完整性檢查（孤立記錄、外鍵）
- [ ] 執行業務邏輯驗證
- [ ] 產生驗證報告
- [ ] 備份完整資料庫

---

### 6.2 風險與對策

#### 風險 1：料號重複

**問題**: EMU3000 的料號可能與海軍裝備重複

**影響**: 中等 - 可能導致資料衝突

**對策**:
- 採用智能重複檢查邏輯
- 如果料號和名稱都相同，共用同一個 Item
- 如果料號相同但名稱不同，加後綴區分（item_code + '-EMU3000'）

#### 風險 2：編碼問題

**問題**: Excel 檔案可能包含 Big5 編碼的中文

**影響**: 高 - 可能導致中文亂碼

**對策**:
- 使用 `pd.read_excel()` 並指定 `engine='openpyxl'`
- 資料庫連線使用 UTF-8 編碼
- 在 SQL 連線字串中指定 `client_encoding='UTF8'`

#### 風險 3：檔案格式不一致

**問題**: 發現 8 個檔案格式異常

**影響**: 中等 - 部分檔案無法導入

**對策**:
- 在導入前先檢查欄位名稱
- 對於異常檔案，手動修正或跳過
- 記錄失敗檔案清單，供後續處理

#### 風險 4：交易過大

**問題**: 一次導入太多資料可能導致交易超時或記憶體不足

**影響**: 高 - 可能導致導入失敗

**對策**:
- 分批次導入（每個維護週期提交一次）
- 使用批次插入（每 100 筆提交一次）
- 監控記憶體使用量

#### 風險 5：資料庫鎖定

**問題**: 長時間導入可能鎖定資料表

**影響**: 中等 - 影響其他操作

**對策**:
- 在非尖峰時間進行導入
- 使用交易控制，避免長時間鎖定
- 如果失敗，立即回滾

---

### 6.3 常見問題排除

#### Q1: 資料庫連線失敗

**錯誤訊息**: `could not connect to server`

**原因**:
- PostgreSQL 服務未啟動
- 連線參數錯誤
- 防火牆阻擋

**解決方法**:
1. 檢查 PostgreSQL 服務是否啟動
2. 檢查連線參數（host, port, database, user, password）
3. 檢查防火牆設定
4. 測試連線：
   ```bash
   PGPASSWORD=willlin07 "/c/Program Files/PostgreSQL/16/bin/psql.exe" -U postgres -h localhost -p 5432 -l
   ```

#### Q2: 欄位不存在

**錯誤訊息**: `column "project_code" does not exist`

**原因**: 未執行資料庫結構調整腳本

**解決方法**:
- 執行 `alter_database_for_emu3000.sql` 腳本
- 驗證欄位已建立：
  ```sql
  SELECT column_name FROM information_schema.columns
  WHERE table_name = 'Item' AND column_name = 'project_code';
  ```

#### Q3: 外鍵約束錯誤

**錯誤訊息**: `insert or update on table "BOM_line" violates foreign key constraint`

**原因**:
- 先插入 BOM_LINE，但對應的 Item 或 BOM 不存在
- UUID 錯誤

**解決方法**:
- 確保先插入 Item 和 BOM，再插入 BOM_LINE
- 檢查 UUID 是否正確
- 使用交易確保順序：
  ```python
  conn.begin()
  insert_item()
  insert_bom()
  insert_bom_line()
  conn.commit()
  ```

#### Q4: 重複鍵錯誤

**錯誤訊息**: `duplicate key value violates unique constraint`

**原因**:
- 料號已存在
- UUID 重複

**解決方法**:
- 檢查料號是否已存在：
  ```sql
  SELECT * FROM "Item" WHERE item_code = 'II108258-FA';
  ```
- 使用 `ON CONFLICT DO NOTHING` 或先查詢再插入
- 確保 UUID 使用 `uuid.uuid4()` 生成

#### Q5: 中文亂碼

**錯誤訊息**: 顯示的中文變成亂碼或問號

**原因**: 編碼問題

**解決方法**:
- 確保資料庫編碼為 UTF-8：
  ```sql
  SHOW server_encoding;
  ```
- 確保 Python 連線使用 UTF-8：
  ```python
  conn = psycopg2.connect(
      host="localhost",
      database="sbir_equipment_db_v2",
      user="postgres",
      password="willlin07",
      client_encoding="UTF8"
  )
  ```

#### Q6: Excel 讀取失敗

**錯誤訊息**: `ValueError: Excel file format cannot be determined`

**原因**:
- 檔案路徑錯誤
- 檔案損壞
- 缺少 openpyxl 套件

**解決方法**:
- 檢查檔案路徑是否正確
- 嘗試手動開啟 Excel 檔案
- 安裝 openpyxl：
  ```bash
  pip install openpyxl
  ```

---

### 6.4 成功標準

#### 資料量標準

| 項目 | 預期值 | 驗證方法 |
|-----|--------|---------|
| Item (FG) | 150-200 | `SELECT COUNT(*) FROM "Item" WHERE project_code='EMU3000' AND item_type='FG'` |
| Item (RM) | 3,000-5,000 | `SELECT COUNT(*) FROM "Item" WHERE project_code='EMU3000' AND item_type='RM'` |
| BOM | ~180 | `SELECT COUNT(*) FROM "BOM" WHERE maintenance_period IS NOT NULL` |
| BOM_LINE | 8,000-10,000 | `SELECT COUNT(*) FROM "BOM_line"` |

#### 資料品質標準

| 項目 | 標準 | 驗證方法 |
|-----|------|---------|
| 無孤立記錄 | 0 筆 | 外鍵完整性檢查 SQL |
| 無重複料號 | 0 筆 | 重複檢查 SQL |
| UUID 格式正確 | 100% | 使用 `uuid_in()` 驗證 |
| project_code 正確 | 100% | 所有 EMU3000 記錄都有 'EMU3000' |

#### 業務邏輯標準

| 項目 | 標準 | 驗證方法 |
|-----|------|---------|
| 可查詢裝備的所有零件 | 成功 | 查詢 SQL 測試 |
| 可查詢零件用在哪些裝備 | 成功 | 反向查詢 SQL 測試 |
| 可按維護週期統計 | 成功 | 統計查詢 SQL 測試 |
| 可按 WEC 代碼分類 | 成功 | WEC 統計 SQL 測試 |

---

### 6.5 效能優化建議

#### 優化 1：批次插入

```python
# 不推薦：逐筆插入
for row in df.iterrows():
    cursor.execute("INSERT INTO \"Item\" ...", (...))
    conn.commit()

# 推薦：批次插入（每 100 筆）
batch_size = 100
for i in range(0, len(items), batch_size):
    batch = items[i:i+batch_size]
    cursor.executemany("INSERT INTO \"Item\" ...", batch)
    conn.commit()
```

#### 優化 2：延遲索引建立

```sql
-- 導入前：暫時移除索引
DROP INDEX IF EXISTS idx_item_project;
DROP INDEX IF EXISTS idx_bom_maintenance_period;

-- 執行資料導入...

-- 導入後：重新建立索引
CREATE INDEX idx_item_project ON "Item"(project_code);
CREATE INDEX idx_bom_maintenance_period ON "BOM"(maintenance_period);
```

#### 優化 3：使用 COPY 指令（最快）

```python
from io import StringIO

# 準備 CSV 格式資料
csv_buffer = StringIO()
df.to_csv(csv_buffer, index=False, header=False)
csv_buffer.seek(0)

# 使用 COPY 快速導入
cursor.copy_from(csv_buffer, 'Item', sep=',', columns=(...))
```

#### 優化 4：交易控制

```python
try:
    conn.begin()

    # 導入大量資料...
    for file in files:
        import_file(file)

    conn.commit()
    print("✓ 所有資料導入成功")

except Exception as e:
    conn.rollback()
    print(f"✗ 導入失敗，已回滾: {e}")
```

---

## 附錄 A：完整檔案清單

### A.1 五年維護（60個月）- 1 個檔案

| 序號 | 檔案名稱 | 檔案大小 | 狀態 |
|-----|---------|---------|------|
| 1 | 清潔塊單元C20、C21大修料件清單--60個月.xlsx | 463.9 KB | ✅ OK |

---

### A.2 六年維護（72個月）- 7 個檔案

| 序號 | 子目錄 | 檔案名稱 | 檔案大小 | 狀態 |
|-----|--------|---------|---------|------|
| 1 | 01 剎車鉗單元--C06、C07--OK | 煞車卡鉗單元C07.xlsx | 696.4 KB | ✅ OK |
| 2 | 01 剎車鉗單元--C06、C07--OK | 煞車鉗單元C06.xlsx | 706.2 KB | ✅ OK |
| 3 | 01 剎車鉗單元--C06、C07--OK | 煞車鉗單元C07、C07大修料件清單--72個月.xlsx | 22.8 KB | ⚠️ 格式異常 |
| 4 | 02 遙控--C13--OK | 02 遙控--C13--OK.xlsx | 152.7 KB | ✅ OK |
| 5 | 03 汽笛--P04、P05--OK | 03 汽笛--P04.xlsx | 73.8 KB | ✅ OK |
| 6 | 03 汽笛--P04、P05--OK | 03 汽笛--P04、P05.xlsx | 12.0 KB | ⚠️ 格式異常 |
| 7 | 03 汽笛--P04、P05--OK | 03 汽笛--P05.xlsx | 70.4 KB | ✅ OK |

---

### A.3 八年維護（96個月）- 50 個檔案（主要系統）

| 序號 | 裝備代碼 | 裝備名稱 | 檔案數 | 主要檔案 | 狀態 |
|-----|---------|---------|--------|---------|------|
| 1 | A01 | 空氣供應單元 | 1 | A01--空氣供應系統.xlsx | ✅ OK |
| 2 | A01.01 | 壓縮機組 | 1 | 壓縮機組--A01.01.xlsx | ✅ OK |
| 3 | B10/B11/B12 | 軟管 | 3 | B10/B11/B12--軟管.xlsx | ⚠️ 缺資料 |
| 4 | A01.04 | 空氣乾燥單元 | 1 | A01.04--空氣乾燥單元.xlsx | ✅ OK |
| 5 | A01.06 | 安全閥 | 1 | A01.06--安全閥.xlsx | ✅ OK |
| 6 | A03.02 | 排放閥 | 1 | 排放閥--A03.2.xlsx | ⚠️ 缺文件 |
| 7 | B26/B27 | 角旋塞 | 0 | - | ❌ 無檔案 |
| 8 | B43 | 手動閥 | 1 | B43--手動閥.xlsx | ✅ OK |
| 9 | B44 | 輔助面板 | 1 | B44--輔助面板.xlsx | ✅ OK |
| 10 | - | 煞車控制模組 | 0 | - | ❌ 無檔案 |
| ... | ... | ... | ... | ... | ... |
| 42 | B50.04 | 貯氣器 | 1 | 貯氣器--B50.04.xlsx | ✅ OK |

**詳細清單請參考原始文件**

---

### A.4 十六年維護（192個月）- 33 個檔案

| 序號 | 子目錄 | 檔案數 | 說明 |
|-----|--------|--------|------|
| 1 | 01 浮球閥--(26個位置)--OK | 31 | A02, A05, A10, B13, B22-B25, B31, B40-B42, D04, D19-D20, L03, N04, P01, T01, U05, U11 |
| 2 | 02 測試接頭--(6個位置) | 2 | A01.07, B14 |

---

## 附錄 B：裝備代碼索引

### B.1 按代碼排序（前50個，完整清單請參考原始文件）

| 代碼 | 裝備名稱 | 維護週期 | 說明 |
|-----|---------|---------|------|
| A01 | 空氣供應單元 | 96M | 最複雜系統，34 個位置 |
| A01.01 | 壓縮機組 | 96M | A01 子系統 |
| A01.04 | 空氣乾燥單元 | 96M | A01 子系統 |
| A01.06 | 安全閥 | 96M | A01 子系統 |
| A01.07 | 測試接頭 | 192M | 維修測試用 |
| A02 | 浮球閥 | 192M | 廁所/水箱水位控制 |
| A03.02 | 排放閥 | 96M | 氣壓釋放 |
| A05 | 浮球閥 | 192M | 多個位置（L/R/1）|
| A10 | 浮球閥 | 192M | 左右各一（L/R）|
| B10 | 軟管 | 96M | 氣動管路 |
| ... | ... | ... | ... |

---

### B.2 按系統分類

#### 氣動系統（A 系列）
A01, A01.01, A01.04, A01.06, A01.07, A02, A03.02, A05, A10

#### 煞車系統（B 系列）
B10-B13, B14, B22-B27, B31-B33, B40-B44, B50 系列, Bxx 系列, B5x 系列

#### 煞車鉗/控制（C 系列）
C06, C07, C11-C13, C20, C21

#### 駕駛控制（D 系列）
D01, D03, D04, D07, D10-D13, D15-D20

#### 防滑系統（G 系列）
G01 (M/T)

#### 水平閥（L 系列）
L03-L05

#### 緊急/警示（N 系列）
N01, N02, N04, N05

#### 氣動附件（P 系列）
P01, P02, P04, P05

#### 廁所系統（T 系列）
T01

#### 公用設施（U 系列）
U01, U01.01, U01.05, U05-U07, U11

---

## 附錄 C：實際資料範例

### C.1 A01 空氣供應系統（定檢件工作表）

**檔案**：`A01--空氣供應系統.xlsx`
**工作表**：定檢件
**總行數**：921 行
**實際零件數**：290 個
**裝備位置數**：34 個（A01T0 ~ A01T33）

#### 資料範例（前 10 行）

| Part | Item number | Quantity | Unit | Name | WEC | Notes |
|------|-------------|----------|------|------|-----|-------|
| *(空)* | 11108258 | *(空)* | *(空)* | AIR SUPPLY UNIT | *(空)* | **A01T0** |
| 1.0 | II108258-FA | 1.0 | Pce | FRAME | *(空)* | *(空)* |
| 2.0 | 8.181.2.321.173.9 | 1.0 | Pce | COMPRESSOR SET VV180-T2.0 | *(空)* | *(空)* |
| 3.0 | 11111516 | 1.0 | Pce | AIR DRYER UNIT LTZ015.2H | *(空)* | *(空)* |
| 4.0 | II108258-MI | 1.0 | Pce | PIPE SET | *(空)* | *(空)* |
| 5.0 | II108258-EM | 1.0 | Pce | ELECT.INSTALLATION | *(空)* | *(空)* |
| 6.0 | II108258-PE | 1.0 | Pce | GROUNDING | *(空)* | *(空)* |
| 22.0 | N64990/5 | 2.0 | Pce | DUST CAP | *(空)* | *(空)* |
| *(空)* | II108258-FA | *(空)* | *(空)* | FRAME | *(空)* | **A01T1** |
| 1.0 | II108258-FS | 1.0 | Pce | FRAME | *(空)* | *(空)* |

---

### C.2 浮球閥--A02（定檢件工作表）

**檔案**：`浮球閥--A02-OK.xlsx`
**工作表**：定檢件
**總行數**：2 行
**實際零件數**：1 個
**裝備位置數**：1 個（A02T0）

#### 資料範例

| Part | Item number | Quantity | Unit | Name | WEC | Notes |
|------|-------------|----------|------|------|-----|-------|
| *(空)* | II50172/2A1R | *(空)* | *(空)* | BALLCOCK | *(空)* | **A02T0** |
| 8.0 | C103832/A | 1.0 | Pce | T-HANDLE | *(空)* | *(空)* |

---

### C.3 清潔塊單元（定檢件工作表）

**檔案**：`清潔塊單元C20、C21大修料件清單--60個月.xlsx`
**工作表**：定檢件
**總行數**：35 行
**實際零件數**：16 個
**裝備位置數**：1 個（C20T0）

#### 資料範例（前 8 行）

| Part | Item number | Quantity | Unit | Name | WEC | Notes |
|------|-------------|----------|------|------|-----|-------|
| *(空)* | II73643/4WU | *(空)* | *(空)* | CLEAN. BLOCK UNIT 清潔塊單元 | *(空)* | **C20T0** |
| 3.0 | C103767/WU | 1.0 | Pce | BLOCK HOLDER | *(空)* | *(空)* |
| 15.0 | 1150430/1 | 1.0 | Pce | TERMINAL BLOCK | *(空)* | *(空)* |
| 18.0 | 470918 | 4.0 | Pce | HEXAGON HEAD SCREW | *(空)* | *(空)* |
| 27.0 | A39947/9 | 1.0 | Pce | THREAD CAP | *(空)* | *(空)* |
| 30.0 | B66529/5 | 1.0 | Pce | BREATHER PLUG | *(空)* | *(空)* |

---

## 📝 文件更新記錄

| 版本 | 日期 | 更新內容 | 更新人員 |
|------|------|---------|---------|
| 1.0 | 2025-11-24 | 初版建立（三個獨立文件）| SBIR 團隊 |
| 2.0 | 2025-11-24 | 統整版建立（本文件）| SBIR 團隊 |

---

## 📧 聯絡資訊

如有任何問題或需要補充資料，請聯絡：

- **專案負責人**：SBIR 專案團隊
- **資料庫架構**：參考 `Database/docs/資料庫中英文對照表.md`
- **相關文件**：`Database/docs/20-EMU3000系統/` 目錄

---

**文件結束**
