# SBIR 裝備資料庫結構說明 (V4.0)

## 📊 資料庫資訊

| 項目 | 說明 |
|------|------|
| **資料庫名稱** | sbir_equipment_db_v3 |
| **版本** | V4.0 |
| **用途** | 海軍裝備管理系統 + Web 應用整合 + NSN 申編搜尋系統 |
| **編碼** | UTF8 |
| **最後更新** | 2025-12-27 |
| **總表數** | 34 個資料表（web_app: 19 + public: 15）+ 5 個視圖 |

### 架構特點

- **雙 Schema 架構**：
  - `web_app`: 裝備管理系統 + Web 應用（19 個表格）
  - `public`: NSN 搜尋系統（15 個表格 + 5 個視圖）
- Item 自我關聯 BOM 結構
- UUID 主鍵設計
- 擴展表模式（減少 NULL 欄位）
- 統一時間戳命名（date_created / date_updated）

---

## 📋 欄位標記說明

| 標記 | 說明 |
|------|------|
| 🔑 | 主鍵 (Primary Key) |
| 🔗 | 外鍵 (Foreign Key) |
| ⭐ | 必填欄位 (Required) |
| 📝 | 選填欄位 (Optional) |
| 🔄 | 自動產生 (Auto Generated) |

---

## 📑 目錄

- [web_app Schema - 資料表總覽](#web_app-schema---資料表總覽)
- [1. User - 使用者管理](#1-user---使用者管理)
- [2. supplier - 廠商主檔](#2-supplier---廠商主檔)
- [3. item - 品項主檔](#3-item---品項主檔)
- [4. item_equipment_ext - 裝備擴展表](#4-item_equipment_ext---裝備擴展表)
- [5. item_material_ext - 料件擴展表](#5-item_material_ext---料件擴展表)
- [6. application - 申編單主表](#6-application---申編單主表)
- [7. mrc - 品項規格表](#7-mrc---品項規格表)
- [8. bom / bom_line - BOM 結構](#8-bom--bom_line---bom-結構)
- [9. 其他表格](#9-其他表格)
- [public Schema - NSN 搜尋系統](#public-schema---nsn-搜尋系統)
- [資料表關聯圖](#資料表關聯圖)

---

## web_app Schema - 資料表總覽

| 編號 | 表名 | 中文名稱 | 主鍵 | 說明 |
|------|------|---------|------|------|
| 1 | User | 使用者管理 | UUID | 系統使用者帳號 |
| 2 | supplier | 廠商主檔 | SERIAL | 供應商/製造商 |
| 3 | item | 品項主檔 ⭐ | UUID | 統一品項資料（核心表） |
| 4 | item_equipment_ext | 裝備擴展表 | UUID (FK) | 裝備類型專用欄位 |
| 5 | item_material_ext | 料件擴展表 | UUID (FK) | 料件類型專用欄位 |
| 6 | item_emu3000_maintenance_ext | EMU3000 擴展 | UUID | EMU3000 維修物料 |
| 7 | application | 申編單主表 ⭐ | UUID | 申編單核心資料 |
| 8 | applicationattachment | 附件管理 | UUID | 申編單附件 |
| 9 | mrc | 品項規格表 | UUID | 品項規格資料 |
| 10 | bom | BOM 主表 | UUID | BOM 版本控制 |
| 11 | bom_line | BOM 明細行 | UUID | BOM 元件清單 |
| 12 | item_number_xref | 零件號碼關聯 | SERIAL | 品項-零件號-廠商關聯 |
| 13 | technicaldocument | 技術文件檔 | SERIAL | 技術文件主檔 |
| 14 | item_document_xref | 品項文件關聯 | 複合鍵 | 品項-文件多對多 |
| 15 | application_suppliercode | 廠商代號申請 | UUID | 廠商代號申請表 |
| 16 | cidapplication | CID 申請單 | UUID | CID 申請表單 |
| 17 | usersession | 工作階段 | VARCHAR | 使用者 Session |
| 18 | applicationlog | 應用程式日誌 | UUID | 運行日誌 |
| 19 | auditlog | 稽核日誌 | UUID | 操作審計追蹤 |

---

## 1. User - 使用者管理

**用途**: 系統使用者帳號管理

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| id | 使用者 UUID | UUID | 🔑🔄 | 自動生成 |
| username | 使用者帳號 | VARCHAR(80) | ⭐ UNIQUE | 登入帳號 |
| email | 電子郵件 | VARCHAR(120) | ⭐ UNIQUE | Email |
| password_hash | 密碼雜湊值 | VARCHAR(256) | ⭐ | 加密密碼 |
| english_code | 英文代碼 | VARCHAR(10) | 📝 | 英文代號 |
| full_name | 全名 | VARCHAR(100) | 📝 | 完整姓名 |
| department | 部門 | VARCHAR(100) | 📝 | 所屬部門 |
| position | 職位 | VARCHAR(100) | 📝 | 職稱 |
| phone | 電話 | VARCHAR(20) | 📝 | 聯絡電話 |
| role | 角色權限 | VARCHAR(50) | 📝 | admin/user/viewer |
| is_active | 帳號啟用 | BOOLEAN | 📝 | 是否啟用 |
| is_verified | 郵件驗證 | BOOLEAN | 📝 | Email 已驗證 |
| email_verified_at | 驗證時間 | TIMESTAMP | 📝 | 驗證時間戳 |
| last_login_at | 最後登入 | TIMESTAMP | 📝 | 最後登入時間 |
| failed_login_attempts | 失敗次數 | INT | 📝 | 連續失敗次數 |
| locked_until | 鎖定至 | TIMESTAMP | 📝 | 鎖定解除時間 |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

---

## 2. supplier - 廠商主檔

**用途**: 管理供應商/製造商基本資料

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| supplier_id | 廠商 ID | SERIAL | 🔑🔄 | 自動編號 |
| supplier_code | 廠商代號 | VARCHAR(20) | UNIQUE | 廠商代碼 |
| cage_code | CAGE 代號 | VARCHAR(20) | UNIQUE | CAGE CODE |
| supplier_name_en | 英文名稱 | VARCHAR(200) | ⭐ | 英文廠商名 |
| supplier_name_zh | 中文名稱 | VARCHAR(100) | 📝 | 中文廠商名 |
| agent_name | 代理商名稱 | VARCHAR(255) | 📝 | 代理商（製造商填 NULL） |
| country_code | 國家代碼 | VARCHAR(10) | 📝 | 國別代碼 |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

---

## 3. item - 品項主檔

**用途**: 統一管理所有品項（成品/半成品/原物料）- 核心表

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| item_uuid | 品項 UUID | UUID | 🔑🔄 | 自動生成 |
| item_code | 統一識別碼 | VARCHAR(50) | ⭐ UNIQUE | CID 或 NIIN |
| item_name_zh | 中文品名 | VARCHAR(100) | ⭐ | 中文名稱 |
| item_name_en | 英文品名 | VARCHAR(200) | ⭐ | 英文名稱 |
| item_type | 品項類型 | VARCHAR(10) | ⭐ | FG/SEMI/RM |
| uom | 計量單位 | VARCHAR(10) | 📝 | EA/SET/LOT |
| status | 狀態 | VARCHAR(20) | 📝 | Active/Inactive |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

**約束**: `item_type IN ('FG', 'SEMI', 'RM')`, `status IN ('Active', 'Inactive')`

---

## 4. item_equipment_ext - 裝備擴展表

**用途**: 裝備類型專用欄位（FG 類型）

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| item_uuid | 品項 UUID | UUID | 🔑🔗 | FK → item |
| equipment_type | 裝備形式 | VARCHAR(50) | 📝 | 型號/型式 |
| ship_type | 艦型 | VARCHAR(50) | 📝 | 適用艦型 |
| usage_location | 裝設地點 | VARCHAR(100) | 📝 | 安裝位置 |
| parent_equipment_zh | 上層裝備中文 | VARCHAR(100) | 📝 | 父裝備中文名 |
| parent_equipment_en | 上層裝備英文 | VARCHAR(200) | 📝 | 父裝備英文名 |
| parent_cid | 上層 CID | VARCHAR(50) | 📝 | 父裝備識別碼 |
| eswbs_code | ESWBS 碼 | VARCHAR(20) | 📝 | 族群結構碼 |
| system_function_name | 系統功能名稱 | VARCHAR(200) | 📝 | 系統功能說明 |
| installation_qty | 同類型數量 | INT | 📝 | 單艦裝置數量 |
| total_installation_qty | 全艦裝置數 | INT | 📝 | 全艦總數 |
| maintenance_level | 維修等級 | VARCHAR(10) | 📝 | 維修等級代碼 |
| equipment_serial | 裝備序號 | VARCHAR(50) | UNIQUE | 裝備識別編號 |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

**外鍵**: `item_uuid` → `item.item_uuid` (ON DELETE CASCADE)

---

## 5. item_material_ext - 料件擴展表

**用途**: 料件類型專用欄位（SEMI/RM 類型）

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| item_uuid | 品項 UUID | UUID | 🔑🔗 | FK → item |
| item_id_last5 | 後五碼 | VARCHAR(5) | 📝 | 快速識別用 |
| item_name_zh_short | 簡短中文名 | VARCHAR(20) | 📝 | 9字內 |
| nsn | NSN/國家料號 | VARCHAR(20) | UNIQUE | NATO Stock Number |
| inc_code | INC 代碼 | VARCHAR(20) | 📝 | INC 分類碼 |
| fiig_code | FIIG 代碼 | VARCHAR(20) | 📝 | FIIG 碼 |
| category_code | 統一組類別 | VARCHAR(10) | 📝 | 品項分類 |
| item_code | 品名代號 | VARCHAR(10) | 📝 | INC 品名代號 |
| fiig | FIIG | VARCHAR(10) | 📝 | 聯邦品項識別指南 |
| weapon_system_code | 武器系統代號 | VARCHAR(20) | 📝 | 所屬武器系統 |
| accounting_unit_code | 會計編號 | VARCHAR(20) | 📝 | 會計科目代號 |
| issue_unit | 撥發單位 | VARCHAR(10) | 📝 | EA/SET/LOT |
| unit_price | 美金單價 | DECIMAL(10,2) | 📝 | 單位價格 |
| unit_pack_quantity | 單位包裝量 | INT | 📝 | 包裝數量 |
| weight_kg | 重量(KG) | DECIMAL(10,3) | 📝 | 單位重量 |
| has_stock | 有無料號 | BOOLEAN | 📝 | 是否有庫存 |
| storage_life_months | 存儲壽限 | VARCHAR(10) | 📝 | 儲存期限代碼 |
| file_type_code | 檔別代號 | VARCHAR(10) | 📝 | 檔案類型 |
| file_type_category | 檔別區分 | VARCHAR(10) | 📝 | 檔案分類 |
| secrecy_code | 機密性代號 | VARCHAR(10) | 📝 | 機密等級 |
| expendability_code | 消耗性代號 | VARCHAR(10) | 📝 | 消耗品分類 |
| spec_indicator | 規格指示 | VARCHAR(10) | 📝 | 規格指標 |
| navy_source | 海軍來源 | VARCHAR(50) | 📝 | 來源說明 |
| storage_type_code | 儲存型式 | VARCHAR(20) | 📝 | 儲存方式 |
| storage_life_action_code | 壽限處理 | VARCHAR(10) | 📝 | 壽限管理代號 |
| manufacturability_code | 製造能量 | VARCHAR(10) | 📝 | 製造能力 |
| repairability_code | 修理能量 | VARCHAR(10) | 📝 | 修理能力 |
| source_code | 來源代號 | VARCHAR(10) | 📝 | 來源分類 |
| project_code | 專案代號 | VARCHAR(20) | 📝 | 所屬專案 |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

**外鍵**: `item_uuid` → `item.item_uuid` (ON DELETE CASCADE)

---

## 6. application - 申編單主表

**用途**: 申編單核心資料管理

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| id | 申編單 UUID | UUID | 🔑🔄 | 自動生成 |
| user_id | 申請人 | UUID | 🔗 | FK → User |
| item_uuid | 關聯品項 | UUID | 🔗 | FK → item ⭐ |
| form_serial_number | 表單序號 | VARCHAR(50) | 📝 | 申編單編號 |
| system_code | 系統代碼 | VARCHAR(100) | 📝 | 系統分類 |
| mrc_data | MRC 資料 | JSON | 📝 | 規格資料 |
| applicant_unit | 申請單位 | VARCHAR(100) | 📝 | 申請部門 |
| contact_info | 聯絡資訊 | VARCHAR(100) | 📝 | 聯絡方式 |
| apply_date | 申請日期 | DATE | 📝 | 申請日 |
| official_nsn_stamp | NSN 印章 | VARCHAR(10) | 📝 | NSN 章戳 |
| official_nsn_final | 最終 NSN | VARCHAR(20) | 📝 | 正式 NSN |
| nsn_filled_at | NSN 填寫時間 | TIMESTAMP | 📝 | 填寫時間戳 |
| nsn_filled_by | NSN 填寫者 | UUID | 🔗 | FK → User |
| closed_at | 結案時間 | TIMESTAMP | 📝 | 結案時間戳 |
| closed_by | 結案者 | UUID | 🔗 | FK → User |
| status | 狀態 | VARCHAR(50) | 📝 | pending/approved |
| sub_status | 子狀態 | VARCHAR(50) | 📝 | 詳細狀態 |
| deleted_at | 軟刪除時間 | TIMESTAMP | 📝 | 軟刪除標記 |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

**外鍵關聯**:
- `user_id` → `User.id`
- `item_uuid` → `item.item_uuid` (ON DELETE SET NULL)
- `nsn_filled_by` → `User.id`
- `closed_by` → `User.id`

**備註**: 料件詳細資訊透過 `item_uuid` 關聯至擴展表（item_material_ext, item_equipment_ext）

---

## 7. mrc - 品項規格表

**用途**: 記錄品項的規格資料

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| mrc_uuid | MRC UUID | UUID | 🔑🔄 | 自動生成 |
| item_uuid | 品項 UUID | UUID | 🔗⭐ | FK → item |
| spec_no | 規格順序 | INT | 📝 | 順序編號 |
| spec_abbr | 規格縮寫 | VARCHAR(20) | 📝 | 規格簡稱 |
| spec_en | 規格英文 | VARCHAR(200) | 📝 | 規格項目英文 |
| spec_zh | 規格中文 | VARCHAR(200) | 📝 | 規格項目中文 |
| answer_en | 英答 | VARCHAR(200) | 📝 | 規格值英文 |
| answer_zh | 中答 | VARCHAR(200) | 📝 | 規格值中文 |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

**外鍵**: `item_uuid` → `item.item_uuid` (ON DELETE CASCADE)

---

## 8. bom / bom_line - BOM 結構

### bom（BOM 主表）

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| bom_uuid | BOM UUID | UUID | 🔑🔄 | 自動生成 |
| item_uuid | 成品料號 | UUID | 🔗⭐ | FK → item |
| bom_code | BOM 編號 | VARCHAR(50) | 📝 | BOM 識別碼 |
| revision | 版次 | VARCHAR(20) | 📝 | 版本號 |
| effective_from | 生效日 | DATE | 📝 | 開始生效 |
| effective_to | 失效日 | DATE | 📝 | 結束生效 |
| status | 狀態 | VARCHAR(20) | 📝 | Released/Draft |
| remark | 備註 | TEXT | 📝 | 備註說明 |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

### bom_line（BOM 明細行）

| 欄位名 | 中文名稱 | 資料類型 | 標記 | 說明 |
|--------|---------|---------|------|------|
| line_uuid | 行 UUID | UUID | 🔑🔄 | 自動生成 |
| bom_uuid | BOM UUID | UUID | 🔗⭐ | FK → bom |
| line_no | 行號 | VARCHAR(50) | ⭐ | 排序用 |
| component_item_uuid | 元件料號 | UUID | 🔗⭐ | FK → item（元件） |
| qty_per | 單位用量 | DECIMAL(10,4) | ⭐ | 每單位成品需要量 |
| scrap_type | 損耗型態 | VARCHAR(20) | 📝 | 損耗計算方式 |
| scrap_rate | 損耗率 | DECIMAL(5,4) | 📝 | 損耗百分比 |
| uom | 用量單位 | VARCHAR(10) | 📝 | 預設跟元件一致 |
| position | 裝配位置 | VARCHAR(100) | 📝 | 裝配站別 |
| remark | 備註 | TEXT | 📝 | |
| date_created | 建立時間 | TIMESTAMP | 🔄 | |
| date_updated | 更新時間 | TIMESTAMP | 🔄 | |

---

## 9. 其他表格

### applicationattachment（附件管理）
申編單附件，支援 BYTEA 二進制儲存。

### item_number_xref（零件號碼關聯）
品項-零件號-廠商的多對多關聯。

### technicaldocument（技術文件檔）
技術文件與圖面資料管理。

### item_document_xref（品項文件關聯）
品項與技術文件的多對多關聯。

### application_suppliercode（廠商代號申請）
廠商代號申請表單。

### cidapplication（CID 申請單）
CID 申請表單。

### item_emu3000_maintenance_ext（EMU3000 擴展）
EMU3000 維修物料清單專屬欄位。

### usersession（工作階段管理）
使用者登入 Session 管理。

### applicationlog（應用程式日誌）
應用程式運行日誌。

### auditlog（稽核日誌）
操作審計追蹤。

---

## public Schema - NSN 搜尋系統

### 資料表總覽（15 個表 + 5 個視圖）

| 分類 | 表名 | 說明 | 記錄數 |
|------|------|------|--------|
| **FSG/FSC** | fsg | 聯邦補給群組 | ~80 |
| | fsc | 聯邦補給分類 | ~650 |
| | inc_fsc_xref | INC-FSC 對應 | ~78,000 |
| **NATO H6** | nato_h6_item_name | H6 物品名稱 | ~60,000 |
| | nato_h6_inc_xref | H6-INC 對應 | ~60,000 |
| **INC** | inc | 物品名稱代碼 | ~80,000 |
| | colloquial_inc_xref | 俗語對應 | ~142,000 |
| **FIIG** | fiig | 識別指南 | ~2,900 |
| | fiig_inc_xref | FIIG-INC 對應 | ~79,000 |
| **MRC** | mrc_key_group | MRC 群組 | ~50 |
| | mrc | 需求代碼 | ~16,700 |
| | fiig_inc_mrc_xref ⭐ | 三元對應 | ~1,700,000 |
| | mrc_reply_table_xref | MRC-回應對應 | ~72,000 |
| **回應** | reply_table | 回應表主檔 | ~160,000 |
| **其他** | mode_code_edit | 模式碼指南 | ~20 |

### 查詢視圖

| 視圖名稱 | 說明 |
|---------|------|
| v_h6_inc_mapping | H6 → INC 完整對應 |
| v_inc_fiig_mapping | INC → FIIG 完整對應 |
| v_fiig_mrc_requirements | FIIG → MRC 申編需求 |
| v_mrc_reply_options | MRC 回應選項 |
| v_application_flow | 端到端申編流程 |

---

## 資料表關聯圖

```
sbir_equipment_db_v3 (PostgreSQL 16)
│
├─ web_app Schema（19 個表格）
│  ┌──────────────────────────────────────────────────┐
│  │                裝備管理系統                       │
│  │                                                   │
│  │  supplier ─── item_number_xref ─── item ⭐       │
│  │                                      │            │
│  │              ┌───────────────────────┼────────┐   │
│  │              │                       │        │   │
│  │     item_equipment_ext    item_material_ext   │   │
│  │                                      │        │   │
│  │              bom ─── bom_line ───────┘        │   │
│  │                                               │   │
│  │              mrc ─────────────────────────────┘   │
│  │              item_document_xref ── technicaldocument
│  └───────────────────────────────────────────────────┘
│                           │
│                           │ item_uuid (FK)
│                           ↓
│  ┌──────────────────────────────────────────────────┐
│  │                Web 應用系統                       │
│  │                                                   │
│  │  User ─┬─ usersession                            │
│  │        ├─ application ─── applicationattachment  │
│  │        ├─ auditlog                               │
│  │        └─ applicationlog                         │
│  └───────────────────────────────────────────────────┘
│
└─ public Schema（15 個表格 + 5 個視圖）
   ┌──────────────────────────────────────────────────┐
   │           NSN 申編搜尋系統（220萬筆）             │
   │                                                   │
   │  FSG → FSC ← inc_fsc_xref → INC ⭐               │
   │                               ↕                   │
   │                    nato_h6_inc_xref               │
   │                               ↕                   │
   │                       NATO H6 Item                │
   │                                                   │
   │  INC ← colloquial_inc_xref                       │
   │   ↕                                               │
   │  fiig_inc_xref → FIIG                            │
   │   ↕                                               │
   │  fiig_inc_mrc_xref (170萬) → MRC                 │
   │                               ↕                   │
   │                    mrc_reply_table_xref           │
   │                               ↕                   │
   │                          reply_table              │
   └───────────────────────────────────────────────────┘
```

---

## 時間戳命名規範

所有表格統一使用：
- `date_created` - 記錄建立時間
- `date_updated` - 記錄更新時間

**例外**: `applicationlog` 使用 `timestamp` + `created_date`

---

**文件版本**: 4.0  
**最後更新**: 2025-12-27  
**維護單位**: SBIR 專案團隊
