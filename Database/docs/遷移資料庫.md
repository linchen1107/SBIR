# è³‡æ–™åº«é·ç§»èªªæ˜æ–‡ä»¶

## ğŸ“‹ æ¦‚è¿°

- **é·ç§»æ—¥æœŸ**: 2025-12-26
- **ä¾†æºè³‡æ–™åº«**: `web_app` schema (èˆŠç‰ˆ 51 æ¬„ä½ applications + users)
- **ç›®æ¨™è³‡æ–™åº«**: `sbir_equipment_db_v3` - `web_app` schema (V3.2 æ­£è¦åŒ–çµæ§‹)
- **é·ç§»æ–¹å¼**: 51 æ¬„ä½éæ­£è¦åŒ–è¡¨æ‹†åˆ†ç‚º 8 å€‹æ­£è¦åŒ–è¡¨

---

## ğŸ“Š é·ç§»æ¶æ§‹

### èˆŠçµæ§‹ â†’ æ–°çµæ§‹å°ç…§

```
èˆŠçµæ§‹ (éæ­£è¦åŒ–)                    æ–°çµæ§‹ (V3.2 æ­£è¦åŒ–)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ web_app.users       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚ web_app.User        â”‚
â”‚ (18 æ¬„ä½)           â”‚            â”‚ (18 æ¬„ä½)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ web_app.applicationsâ”‚            â”‚ web_app.item        â”‚
â”‚ (51 æ¬„ä½)           â”‚            â”‚ (å“é …ä¸»æª”)          â”‚
â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒ…å«:               â”‚            â”‚ web_app.item_       â”‚
â”‚ - å“é …è³‡è¨Š          â”‚            â”‚ material_ext        â”‚
â”‚ - ç‰©æ–™å±¬æ€§          â”‚            â”‚ (æ–™ä»¶æ“´å±•)          â”‚
â”‚ - è£å‚™è³‡è¨Š          â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ä¾›æ‡‰å•†è³‡è¨Š        â”‚            â”‚ web_app.item_       â”‚
â”‚ - æ–‡ä»¶åƒè€ƒ          â”‚            â”‚ equipment_ext       â”‚
â”‚ - ç”³è«‹æµç¨‹          â”‚            â”‚ (è£å‚™æ“´å±•)          â”‚
â”‚                     â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ web_app.supplier    â”‚
                                   â”‚ (ä¾›æ‡‰å•†)            â”‚
                                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                   â”‚ web_app.technical   â”‚
                                   â”‚ document            â”‚
                                   â”‚ (æŠ€è¡“æ–‡ä»¶)          â”‚
                                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                   â”‚ web_app.item_       â”‚
                                   â”‚ number_xref         â”‚
                                   â”‚ (æ–™è™Ÿå°ç…§)          â”‚
                                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                   â”‚ web_app.application â”‚
                                   â”‚ (ç”³è«‹å–®)            â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ é·ç§»è³‡æ–™è¡¨æ¸…å–®

| åºè™Ÿ | èˆŠè¡¨å | æ–°è¡¨å | è¨˜éŒ„æ•¸ | èªªæ˜ |
|------|--------|--------|--------|------|
| 1 | `users` | `User` | 9 | ä½¿ç”¨è€…ä¸»æª” |
| 2 | `applications` | `item` | 1,001 | å“é …ä¸»æª” (å«æ—¢æœ‰è³‡æ–™) |
| 3 | `applications` | `item_material_ext` | 38 | æ–™ä»¶æ“´å±•å±¬æ€§ |
| 4 | `applications` | `item_equipment_ext` | 38 | è£å‚™æ“´å±•å±¬æ€§ |
| 5 | `applications` | `supplier` | 4 | ä¾›æ‡‰å•† |
| 6 | `applications` | `technicaldocument` | 1 | æŠ€è¡“æ–‡ä»¶ |
| 7 | `applications` | `item_number_xref` | 61 | æ–™è™Ÿå°ç…§è¡¨ |
| 8 | `applications` | `application` | 121 | ç”³è«‹å–® |

---

## ğŸ”„ è©³ç´°æ¬„ä½å°ç…§è¡¨

### 1. users â†’ User

| èˆŠæ¬„ä½å | æ–°æ¬„ä½å | è³‡æ–™é¡å‹ | è®Šæ›´èªªæ˜ |
|----------|----------|----------|----------|
| `id` | `id` | UUID | ç„¡è®Šæ›´ |
| `username` | `username` | VARCHAR(80) | ç„¡è®Šæ›´ |
| `email` | `email` | VARCHAR(120) | ç„¡è®Šæ›´ |
| `password_hash` | `password_hash` | VARCHAR(256) | ç„¡è®Šæ›´ |
| `english_code` | `english_code` | VARCHAR(10) | ç„¡è®Šæ›´ |
| `full_name` | `full_name` | VARCHAR(100) | ç„¡è®Šæ›´ |
| `department` | `department` | VARCHAR(100) | ç„¡è®Šæ›´ |
| `position` | `position` | VARCHAR(100) | ç„¡è®Šæ›´ |
| `phone` | `phone` | VARCHAR(20) | ç„¡è®Šæ›´ |
| `role` | `role` | VARCHAR(50) | ç„¡è®Šæ›´ |
| `is_active` | `is_active` | BOOLEAN | ç„¡è®Šæ›´ |
| `is_verified` | `is_verified` | BOOLEAN | ç„¡è®Šæ›´ |
| `email_verified_at` | `email_verified_at` | TIMESTAMP | ç„¡è®Šæ›´ |
| `last_login_at` | `last_login_at` | TIMESTAMP | ç„¡è®Šæ›´ |
| `failed_login_attempts` | `failed_login_attempts` | INT | ç„¡è®Šæ›´ |
| `locked_until` | `locked_until` | TIMESTAMP | ç„¡è®Šæ›´ |
| `created_at` | `date_created` | TIMESTAMP | â­ æ¬„ä½é‡å‘½å |
| `updated_at` | `date_updated` | TIMESTAMP | â­ æ¬„ä½é‡å‘½å |

---

### 2. applications (51æ¬„ä½) â†’ æ­£è¦åŒ–æ‹†åˆ†

#### 2.1 â†’ item (å“é …ä¸»æª”)

| èˆŠæ¬„ä½å | æ–°æ¬„ä½å | èªªæ˜ |
|----------|----------|------|
| `part_number` | `item_code` | æ–™è™Ÿ |
| `chinese_name` | `item_name_zh` | ä¸­æ–‡å“å |
| `english_name` | `item_name_en` | è‹±æ–‡å“å |
| `issue_unit` | `uom` | è¨ˆé‡å–®ä½ |
| - | `item_uuid` | â­ æ–°ç”¢ç”Ÿçš„ UUID |
| - | `item_type` | é è¨­ 'SEMI' |
| - | `status` | é è¨­ 'Active' |

#### 2.2 â†’ item_material_ext (æ–™ä»¶æ“´å±•)

| èˆŠæ¬„ä½å | æ–°æ¬„ä½å | èªªæ˜ |
|----------|----------|------|
| - | `item_uuid` | FK â†’ item |
| `inc_code` | `inc_code` | INC ä»£ç¢¼ |
| `fiig_code` | `fiig_code` | FIIG ä»£ç¢¼ |
| `accounting_unit_code` | `accounting_unit_code` | æœƒè¨ˆå–®ä½ä»£ç¢¼ |
| `issue_unit` | `issue_unit` | ç™¼æ–™å–®ä½ |
| `unit_price` | `unit_price` | å–®åƒ¹ |
| `unit_pack_quantity` | `unit_pack_quantity` | å–®ä½åŒ…è£é‡ (VARCHARâ†’INT) |
| `spec_indicator` | `spec_indicator` | è¦æ ¼æŒ‡ç¤º |
| `storage_life_months` | `storage_life_months` | å„²å­˜å£½å‘½(æœˆ) |
| `storage_life_action_code` | `storage_life_action_code` | å„²å­˜å£½å‘½ä½œæ¥­ç¢¼ |
| `storage_type_code` | `storage_type_code` | å„²å­˜é¡å‹ç¢¼ |
| `secrecy_code` | `secrecy_code` | æ©Ÿå¯†ç¢¼ |
| `expendability_code` | `expendability_code` | æ¶ˆè€—ç¢¼ |
| `repairability_code` | `repairability_code` | ä¿®å¾©ç¢¼ |
| `manufacturability_code` | `manufacturability_code` | è£½é€ ç¢¼ |
| `source_code` | `source_code` | ä¾†æºç¢¼ |
| `category_code` | `category_code` | é¡åˆ¥ç¢¼ |

#### 2.3 â†’ item_equipment_ext (è£å‚™æ“´å±•)

| èˆŠæ¬„ä½å | æ–°æ¬„ä½å | èªªæ˜ |
|----------|----------|------|
| - | `item_uuid` | FK â†’ item |
| `ship_type` | `ship_type` | è‰¦å‹ |
| `usage_location` | `usage_location` | ä½¿ç”¨ä½ç½® |
| `equipment_name` | `parent_equipment_zh` | çˆ¶è£å‚™ä¸­æ–‡å |
| `cid_no` | `cid_no` | CID ç·¨è™Ÿ |
| `model_type` | `model_type` | å‹è™Ÿ |
| `quantity_per_unit` | `quantity_per_unit` | æ¯å–®ä½æ•¸é‡ |

#### 2.4 â†’ supplier (ä¾›æ‡‰å•†)

| èˆŠæ¬„ä½å | æ–°æ¬„ä½å | èªªæ˜ |
|----------|----------|------|
| `manufacturer_name` | `supplier_name` | è£½é€ å•†åç¨± (type='manufacturer') |
| `agent_name` | `supplier_name` | ä»£ç†å•†åç¨± (type='agent') |

#### 2.5 â†’ technicaldocument (æŠ€è¡“æ–‡ä»¶)

| èˆŠæ¬„ä½å | æ–°æ¬„ä½å | èªªæ˜ |
|----------|----------|------|
| `document_reference` | `document_number` | æ–‡ä»¶ç·¨è™Ÿ |
| - | `document_type` | é è¨­ 'reference' |
| - | `document_source` | é è¨­ 'migration' |

#### 2.6 â†’ item_number_xref (æ–™è™Ÿå°ç…§)

| èˆŠæ¬„ä½å | æ–°æ¬„ä½å | èªªæ˜ |
|----------|----------|------|
| `part_number_reference` | `part_number_reference` | åƒè€ƒæ–™è™Ÿ |
| - | `item_uuid` | FK â†’ item |
| - | `pn_acquisition_source` | é è¨­ 'migration' |

#### 2.7 â†’ application (ç”³è«‹å–®)

| èˆŠæ¬„ä½å | æ–°æ¬„ä½å | èªªæ˜ |
|----------|----------|------|
| `id` | `id` | UUID (ä¿ç•™åŸå€¼) |
| `user_id` | `user_id` | FK â†’ User |
| - | `item_uuid` | â­ FK â†’ item (é€é part_number JOIN) |
| `form_serial_number` | `form_serial_number` | è¡¨å–®åºè™Ÿ |
| `system_code` | `system_code` | ç³»çµ±ä»£ç¢¼ |
| `mrc_data` | `mrc_data` | MRC è³‡æ–™ (JSONB) |
| `applicant_unit` | `applicant_unit` | ç”³è«‹å–®ä½ |
| `contact_info` | `contact_info` | è¯çµ¡è³‡è¨Š |
| `apply_date` | `apply_date` | ç”³è«‹æ—¥æœŸ |
| `official_nsn_stamp` | `official_nsn_stamp` | NSN æˆ³è¨˜ |
| `official_nsn_final` | `official_nsn_final` | æœ€çµ‚ NSN |
| `nsn_filled_at` | `nsn_filled_at` | NSN å¡«å…¥æ™‚é–“ |
| `nsn_filled_by` | `nsn_filled_by` | FK â†’ User |
| `closed_at` | `closed_at` | çµæ¡ˆæ™‚é–“ |
| `closed_by` | `closed_by` | FK â†’ User |
| `status` | `status` | ç‹€æ…‹ |
| `sub_status` | `sub_status` | å­ç‹€æ…‹ |
| `created_at` | `created_at` | å»ºç«‹æ™‚é–“ |
| `updated_at` | `updated_at` | æ›´æ–°æ™‚é–“ |
| `deleted_at` | `deleted_at` | åˆªé™¤æ™‚é–“ (è»Ÿåˆªé™¤) |
| `created_at` | `date_created` | å»ºç«‹æ—¥æœŸ |
| `updated_at` | `date_updated` | æ›´æ–°æ—¥æœŸ |

---

## ğŸ“ é·ç§»è…³æœ¬

é·ç§»è…³æœ¬ä½æ–¼ `Database/migrations/` ç›®éŒ„ï¼š

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `01_create_old_data_staging.sql` | å»ºç«‹ old_data schema åŠæš«å­˜è¡¨ |
| `02_migrate_users.sql` | é·ç§»ä½¿ç”¨è€…è³‡æ–™ |
| `03_migrate_applications.sql` | ä¸»è¦é·ç§»è…³æœ¬ (51æ¬„ä½æ‹†åˆ†) |
| `04_verify_and_cleanup.sql` | é©—è­‰èˆ‡æ¸…ç† |
| `MIGRATION_GUIDE.md` | é·ç§»æ“ä½œæŒ‡å— |

---

## â–¶ï¸ åŸ·è¡Œæ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šå»ºç«‹æš«å­˜çµæ§‹
```bash
psql -U postgres -d sbir_equipment_db_v3 -f 01_create_old_data_staging.sql
```

### æ­¥é©Ÿ 2ï¼šåŒ¯å…¥èˆŠè³‡æ–™åˆ°æš«å­˜è¡¨
```powershell
# æ“·å–ä¸¦è½‰æ› INSERT èªå¥
Select-String -Path "export.sql" -Pattern "^INSERT INTO web_app\.users" | 
    ForEach-Object { $_.Line -replace "web_app\.users", "old_data.users" } | 
    Out-File "temp_users.sql" -Encoding UTF8

Select-String -Path "export.sql" -Pattern "^INSERT INTO web_app\.applications" | 
    ForEach-Object { $_.Line -replace "web_app\.applications", "old_data.applications" } | 
    Out-File "temp_applications.sql" -Encoding UTF8

# åŒ¯å…¥
psql -U postgres -d sbir_equipment_db_v3 -f temp_users.sql
psql -U postgres -d sbir_equipment_db_v3 -f temp_applications.sql
```

### æ­¥é©Ÿ 3ï¼šé·ç§»ä½¿ç”¨è€…
```bash
psql -U postgres -d sbir_equipment_db_v3 -f 02_migrate_users.sql
```

### æ­¥é©Ÿ 4ï¼šé·ç§»ç”³è«‹å–® (ä¸»è¦é·ç§»)
```bash
psql -U postgres -d sbir_equipment_db_v3 -f 03_migrate_applications.sql
```

### æ­¥é©Ÿ 5ï¼šé©—è­‰
```bash
psql -U postgres -d sbir_equipment_db_v3 -f 04_verify_and_cleanup.sql
```

---

## âœ… é·ç§»çµæœ (2025-12-26)

### è³‡æ–™çµ±è¨ˆ

| åˆ†é¡ | è¡¨å | è¨˜éŒ„æ•¸ |
|------|------|--------|
| ä¾†æº | old_data.users | 9 |
| ä¾†æº | old_data.applications | 121 |
| ç›®æ¨™ | web_app.User | 9 |
| ç›®æ¨™ | web_app.item | 1,001 |
| ç›®æ¨™ | web_app.item_material_ext | 38 |
| ç›®æ¨™ | web_app.item_equipment_ext | 38 |
| ç›®æ¨™ | web_app.application | 121 |
| ç›®æ¨™ | web_app.supplier | 4 |
| ç›®æ¨™ | web_app.technicaldocument | 1 |
| ç›®æ¨™ | web_app.item_number_xref | 61 |

### å·²é·ç§»ä½¿ç”¨è€…

| ä½¿ç”¨è€…åç¨± | é›»å­éƒµä»¶ | è§’è‰² |
|------------|----------|------|
| C112118237 | c112118237@nkust.edu.tw | admin |
| yjjchen | yjjchen@nkust.edu.tw | user |
| chaohui | chaohui@nkust.edu.tw | user |
| yuan6112 | yuan6112@sh-logistics.com.tw | user |
| Zi_Ching | chingluo9999@gmail.com | user |
| tim | timguanzhi@gmail.com | user |
| ChenTsungLung | yosafireandfroze@gmail.com | user |
| jonaschiu | jonaschiu0809@outlook.com | user |
| test1111 | fafa@gmail.com | user |

---

## âš ï¸ æ³¨æ„äº‹é …

1. **UUID é¡å‹**ï¼šèˆŠè¡¨çš„ `id` æ¬„ä½ç‚º UUID é¡å‹ï¼Œé SERIAL
2. **å¤–éµç´„æŸ**ï¼šApplication è¡¨æœ‰ 3 å€‹å¤–éµæŒ‡å‘ User è¡¨ (user_id, closed_by, nsn_filled_by)
3. **é‡è¤‡è³‡æ–™**ï¼šé·ç§»è…³æœ¬ä½¿ç”¨ `ON CONFLICT DO NOTHING` è™•ç†é‡è¤‡
4. **ç·¨ç¢¼å•é¡Œ**ï¼šWindows ç’°å¢ƒä¸‹ä½¿ç”¨ PowerShell pipe åŸ·è¡Œ SQL å¯èƒ½é‡åˆ° BIG5/UTF8 ç·¨ç¢¼å•é¡Œ
5. **æš«å­˜è³‡æ–™**ï¼šé·ç§»å®Œæˆå¾Œï¼Œold_data schema ä¿ç•™ä½œç‚ºå‚™ä»½ï¼Œå¯åŸ·è¡Œæ¸…ç†è…³æœ¬åˆªé™¤

---

## ğŸ”™ å›æ»¾æ­¥é©Ÿ

å¦‚éœ€å›æ»¾ï¼Œä¾ç…§å¤–éµé †åºåˆªé™¤ï¼š

```sql
-- 1. åˆªé™¤ Application
DELETE FROM web_app.application WHERE id IN (SELECT id FROM old_data.applications);

-- 2. åˆªé™¤é—œè¯è¡¨
DELETE FROM web_app.item_number_xref WHERE pn_acquisition_source = 'migration';
DELETE FROM web_app.technicaldocument WHERE document_source = 'migration';
DELETE FROM web_app.supplier WHERE supplier_type IN ('manufacturer', 'agent');
DELETE FROM web_app.item_equipment_ext WHERE item_uuid IN (
    SELECT item_uuid FROM web_app.item WHERE item_code IN (
        SELECT part_number FROM old_data.applications
    )
);
DELETE FROM web_app.item_material_ext WHERE item_uuid IN (
    SELECT item_uuid FROM web_app.item WHERE item_code IN (
        SELECT part_number FROM old_data.applications
    )
);

-- 3. åˆªé™¤ Item (åªåˆªé™¤é·ç§»æ–°å¢çš„)
DELETE FROM web_app.item WHERE item_code IN (
    SELECT part_number FROM old_data.applications
);

-- 4. åˆªé™¤ User
DELETE FROM web_app."User" WHERE id IN (SELECT id FROM old_data.users);

-- 5. æ¸…ç†æš«å­˜ schema
DROP SCHEMA old_data CASCADE;
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [è³‡æ–™åº«çµæ§‹ v3.2](00-æ•´é«”æ¶æ§‹/01-è³‡æ–™åº«çµæ§‹_v3.2.md)
- [é·ç§»æ“ä½œæŒ‡å—](../migrations/MIGRATION_GUIDE.md)
- [NSN æ¬„ä½å°ç…§è¡¨](00-æ•´é«”æ¶æ§‹/02-NSNæ¬„ä½å°ç…§è¡¨.md)
