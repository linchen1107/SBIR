# NSN 正式料號回填與 BOM 表管理功能

## 功能概述

本功能用於管理申編單的 NSN 正式料號回填流程，以及未來的 BOM 表管理功能。

## 業務流程

### NSN 料號組成
- **臨時料號**: 例如 `4320YETL` (由系統生成或使用者填寫)
- **核准蓋章碼**: 5碼數字，例如 `12345` (由主管單位核發)
- **最終正式料號**: `4320YETL12345` (臨時料號 + 蓋章碼)

### 申編單狀態流程

```
待審核 → 核准 → (回填NSN) → 已結單
```

1. **待審核**: 使用者提交申編單
2. **核准**: 管理員審核通過
3. **回填NSN**: 使用者或管理員填寫核准的5碼蓋章碼
4. **已結單**: 管理員確認結案，鎖定不可修改

## 功能設計

### 1. NSN 正式料號回填

#### 資料庫欄位
在 `applications` 表新增欄位：
- `official_nsn_stamp` (VARCHAR(5)): 存放5碼蓋章碼
- `official_nsn` (VARCHAR(18)): 存放完整的正式料號 (臨時料號 + 蓋章碼)
- `nsn_filled_at` (TIMESTAMP): 回填時間
- `nsn_filled_by` (INTEGER): 回填者的 user_id

#### 顯示位置
- **使用者歷史申編單列表**:
  - 狀態為「核准」或「已結單」時，列表最前方顯示輸入框
  - 可輸入5碼蓋章碼
  - 輸入後自動組合成完整的正式料號並儲存

- **管理員申編單列表**:
  - 所有已核准的申編單前方都可以填寫
  - 管理員可以協助填寫或修改

#### 權限控制

| 狀態 | 使用者可填寫 | 管理員可填寫 | 使用者可修改 | 管理員可修改 |
|------|-------------|-------------|-------------|-------------|
| 待審核 | ✗ | ✗ | ✗ | ✗ |
| 核准 | ✓ | ✓ | ✓ | ✓ |
| 已結單 | ✗ | ✗ | ✗ | ✗* |

*管理員可以將狀態改回「核准」來重新開放修改

#### UI/UX 設計
- 輸入框限制：只能輸入5位數字
- 即時驗證：輸入時檢查格式
- 儲存方式：輸入完成後自動儲存（或提供「確認」按鈕）
- 顯示完整料號：輸入後立即顯示組合後的完整正式料號
- 已填寫顯示：已填寫的申編單顯示完整料號，並標示填寫者和時間

### 2. 已結單狀態

#### 功能說明
- 管理員專用狀態
- 用於標記申編單已完成所有流程，正式結案
- 結單後完全鎖定，不可修改任何資料

#### 狀態切換
- 只有管理員可以將「核准」狀態切換為「已結單」
- 建議要求已填寫正式料號才能結單（可選）
- 管理員可以將「已結單」改回「核准」來重新開放

#### 資料庫欄位
在 `applications` 表新增：
- `status` 欄位新增選項: `'已結單'` 或 `'closed'`
- `closed_at` (TIMESTAMP): 結單時間
- `closed_by` (INTEGER): 結單者的 user_id

### 3. BOM 表管理功能 (未來開發)

#### 功能概述
- 一張 BOM 表可以包含多個申編單
- BOM 表用於管理整批零件的申編狀態
- 可批次查看所有相關申編單的正式料號

#### 資料庫設計
新增 `bom_tables` 表：
- `id` (PRIMARY KEY)
- `bom_name` (VARCHAR): BOM 表名稱
- `bom_number` (VARCHAR): BOM 表編號
- `project_name` (VARCHAR): 專案名稱
- `created_by` (INTEGER): 建立者
- `created_at` (TIMESTAMP)
- `description` (TEXT): 說明

新增 `bom_application_xref` 關聯表：
- `bom_id` (FOREIGN KEY -> bom_tables.id)
- `application_id` (FOREIGN KEY -> applications.id)
- `sequence_number` (INTEGER): 在 BOM 表中的序號

#### BOM 表頁面功能
- 顯示 BOM 表清單
- 建立新的 BOM 表
- 將申編單加入 BOM 表
- BOM 表詳細頁面：
  - 列出所有相關申編單
  - 顯示每個申編單的狀態
  - 顯示正式料號（已填寫的）
  - 匯出 BOM 表報表（Excel/PDF）

## 實作優先順序

### Phase 1: NSN 正式料號回填 (優先)
1. 資料庫遷移：新增 `official_nsn_stamp`、`official_nsn` 等欄位
2. 後端 API：
   - 填寫/更新 NSN 蓋章碼的 API
   - 權限檢查邏輯
3. 前端介面：
   - 在歷史列表和管理員列表加入輸入框
   - 輸入驗證和即時回饋

### Phase 2: 已結單狀態 (優先)
1. 資料庫遷移：新增 `closed_at`、`closed_by` 欄位
2. 後端 API：
   - 狀態切換邏輯
   - 已結單的鎖定檢查
3. 前端介面：
   - 管理員狀態切換按鈕
   - 已結單的視覺標示

### Phase 3: BOM 表管理 (未來)
1. 資料庫設計與遷移
2. BOM 表 CRUD 功能
3. 申編單與 BOM 表關聯管理
4. BOM 表詳細頁面
5. 報表匯出功能

## 技術考量

### 資料驗證
- 5碼蓋章碼格式驗證（正則表達式：`^\d{5}$`）
- 重複性檢查：確保同一個正式料號不會重複
- 臨時料號格式檢查

### 安全性
- API 端權限檢查（不只依賴前端）
- 已結單狀態的強制鎖定
- 審計日誌：記錄所有 NSN 填寫和狀態變更

### 效能考量
- BOM 表頁面的分頁載入
- 申編單列表的索引優化
- 正式料號的索引（方便搜尋）

## 未來擴充可能

1. **批次回填**: 管理員可以批次匯入多個申編單的蓋章碼
2. **自動通知**: 核准後自動通知使用者回填 NSN
3. **統計報表**: 顯示已結單數量、待回填數量等統計資訊
4. **版本控制**: 如果 NSN 需要修改，保留歷史版本
5. **BOM 表模板**: 提供常用的 BOM 表模板

## 參考文件

- [申編單資料表結構](../database/04_Schema_WebApp_Tables.md)
- [業務流程設計](../design/business_logic/03_Business_Process.md)
- [使用者故事](../design/02_User_Stories.md)
