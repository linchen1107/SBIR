# 管理員使用者管理功能實作說明

## 概述
在管理員控制台新增了使用者管理功能，管理員可以查看、編輯、啟用/停用使用者，以及任命其他管理員。

## 功能特點

### 1. Tab 分頁介面
- **申編單管理** - 原有的申編單管理功能
- **使用者管理** - 新增的使用者管理功能
- 使用 Bootstrap 5 Pills 導航，保持一致的深色科技風格

### 2. 使用者列表顯示
顯示以下資訊：
- ID（系統內部編號）
- 帳號 (username)
- Email
- 姓名 (full_name)
- 部門 (department)
- 職位 (position)
- 角色（管理員/一般使用者）
- 狀態（啟用/停用）
- 註冊日期
- 最後登入時間

### 3. 篩選與搜尋
- **搜尋框**：可搜尋帳號、Email、姓名、部門
- **角色篩選**：全部/管理員/一般使用者
- **狀態篩選**：全部/啟用/停用
- **分頁**：支援大量使用者的分頁顯示

### 4. 使用者操作功能

#### 4.1 切換管理員角色
- 路由: `POST /admin/user/<user_id>/toggle-role`
- 功能: 設為管理員 / 取消管理員權限
- 限制: 管理員無法修改自己的角色

#### 4.2 啟用/停用帳號
- 路由: `POST /admin/user/<user_id>/toggle-status`
- 功能: 啟用 / 停用使用者帳號
- 限制: 管理員無法停用自己的帳號

#### 4.3 編輯使用者資料
- 路由:
  - `GET /admin/user/<user_id>/data` - 獲取使用者資料
  - `POST /admin/user/<user_id>/edit` - 更新使用者資料
- 功能: 透過模態框編輯使用者的 Email、姓名、部門、職位、電話等資訊
- 驗證:
  - Email 不可與其他使用者重複
  - 英文代碼（如有）不可重複

### 5. 安全性設計

#### 5.1 權限控制
- 所有使用者管理路由都需要 `@admin_required` 裝飾器
- 防止管理員修改自己的角色或停用自己的帳號

#### 5.2 操作確認
- 切換角色、啟用/停用帳號時需要 JavaScript 確認對話框
- 防止誤操作

#### 5.3 審計日誌
- 所有使用者管理操作都會記錄到 `AuditLog`
- 記錄內容包括：
  - 操作者 ID
  - 操作類型（toggle_user_role, toggle_user_status, edit_user）
  - 目標使用者 ID
  - 變更前後的值
  - IP 位址
  - User Agent

### 6. UI/UX 特點

#### 6.1 視覺設計
- 角色徽章：
  - 管理員：黃色徽章 + 皇冠圖示
  - 一般使用者：藍色徽章 + 使用者圖示
- 狀態徽章：
  - 啟用：綠色徽章 + 勾選圖示
  - 停用：灰色徽章 + 禁止圖示

#### 6.2 操作下拉選單
- 編輯資料
- 設為管理員 / 取消管理員
- 啟用帳號 / 停用帳號
- 自己的帳號顯示「無法修改自己」

#### 6.3 編輯模態框
- 使用 Bootstrap Modal
- AJAX 載入使用者資料
- 表單驗證與錯誤提示

### 7. Tab 切換機制
- URL 參數 `?tab=users` 自動切換到使用者管理 Tab
- JavaScript 自動處理 Tab 狀態同步
- 操作後自動返回對應的 Tab

## 檔案結構

```
app/
├── admin/
│   ├── __init__.py           # 導入 routes 和 user_routes
│   ├── routes.py             # 申編單管理路由（已修改：新增使用者查詢）
│   └── user_routes.py        # 使用者管理路由（新增）
└── templates/
    └── admin/
        └── dashboard.html    # 管理員儀表板（已修改：新增 Tab 和使用者管理區塊）
```

## 路由清單

| 方法 | 路由 | 功能 | 檔案 |
|------|------|------|------|
| GET | `/admin/dashboard` | 管理員儀表板（含使用者列表） | routes.py |
| POST | `/admin/user/<user_id>/toggle-role` | 切換管理員角色 | user_routes.py |
| POST | `/admin/user/<user_id>/toggle-status` | 啟用/停用帳號 | user_routes.py |
| GET | `/admin/user/<user_id>/data` | 獲取使用者資料（JSON） | user_routes.py |
| POST | `/admin/user/<user_id>/edit` | 編輯使用者資料 | user_routes.py |

## 測試建議

### 1. 基本功能測試
- [ ] 切換到使用者管理 Tab，確認使用者列表正確顯示
- [ ] 搜尋功能：輸入帳號/Email/姓名/部門關鍵字
- [ ] 篩選功能：角色篩選、狀態篩選
- [ ] 分頁功能：確認分頁正確運作

### 2. 操作功能測試
- [ ] 設為管理員 → 確認角色變更，徽章更新
- [ ] 取消管理員 → 確認角色變更
- [ ] 停用帳號 → 確認狀態變更，使用者無法登入
- [ ] 啟用帳號 → 確認狀態變更，使用者可以登入
- [ ] 編輯使用者資料 → 確認資料更新成功

### 3. 安全性測試
- [ ] 嘗試修改自己的角色 → 應顯示錯誤訊息
- [ ] 嘗試停用自己的帳號 → 應顯示錯誤訊息
- [ ] 嘗試使用重複的 Email → 應顯示錯誤訊息
- [ ] 嘗試使用重複的英文代碼 → 應顯示錯誤訊息
- [ ] 非管理員訪問使用者管理路由 → 應返回 403 錯誤

### 4. 審計日誌測試
- [ ] 執行各種操作後，檢查 `audit_logs` 資料表
- [ ] 確認記錄包含正確的操作類型、目標使用者、變更內容

## 已知限制與未來改進

### 目前未實作的功能
- [ ] 重置使用者密碼
- [ ] 批量操作（批量啟用/停用）
- [ ] 匯出使用者列表（CSV/Excel）
- [ ] 使用者活動統計圖表
- [ ] 顯示該使用者提交的申編單數量

### 可能的改進
- [ ] 新增使用者搜尋歷史統計
- [ ] 新增使用者登入次數統計
- [ ] 新增使用者最近操作記錄
- [ ] 改善編輯模態框的驗證體驗（即時驗證）

## 實作日期
2025-10-06
